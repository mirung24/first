<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="scalen">
	
	<!-- 매출내역 가져오기 -->
	<select id="scalen_list" parameterType="vo.shopvo.SCalenVO" resultType="vo.shopvo.SCalenVO">
		select 
		   substr(ps.auth_date,7,2) as totday,
		   sum(case when ps.paygubn='ACC' then ifnull(ps.total,0) when ps.paygubn='CAN' then 0-ifnull(ps.total,0) else 0 end) as total,
		   sum(case when ps.paygubn='ACC' then 1 when ps.paygubn='CAN' then -1 else 0 end) as totcnt,
		   sum(case when ps.paygubn='ACC' then ifnull(ps.etcamt,0) when ps.paygubn='CAN' then 0-ifnull(ps.etcamt,0) else 0 end) as etcamt, 
   		   sum(case when ps.paygubn='ACC' and ifnull(etcamt,0)>0 then 1 when ps.paygubn='CAN' and ifnull(etcamt,0)>0 then -1 else 0 end) as etccnt, 
		   sum(case when ps.paygubn='ACC' and ifnull(amt,0)>0 then 1 when ps.paygubn='CAN' and ifnull(amt,0)>0 then -1 else 0 end) as otccnt,
		   sum(case when ps.paygubn='ACC' then ifnull(ps.amt,0)+ifnull(ps.vat,0) when ps.paygubn='CAN' then 0-(ifnull(ps.amt,0)+ifnull(ps.vat,0)) else 0 end) as amt,
		   sum(case when ps.paygubn='ACC' then ifnull(ps.discount,0) when ps.paygubn='CAN' then 0-ifnull(ps.discount,0) else 0 end) as discount,
		   count(distinct concat(ps.name)) as cust
		from 
		(
		    select auth_date,paygubn,total,etcamt,amt,vat,discount,birthday,sex,name
		   from pos_payment_temp
		   where compcd=#{compcd} and auth_date between date_format(now(),'%Y%m%d') and date_format(last_day(cast(concat(#{yearmonth},'01') as date)),'%Y%m%d')
		   union all
		    select auth_date,paygubn,total,etcamt,amt,vat,discount,birthday,sex,name
		   from pos_payment
		   where compcd=#{compcd} and auth_date between concat(#{yearmonth},'01') and date_format(last_day(cast(concat(#{yearmonth},'01') as date)),'%Y%m%d')
		) ps
		group by auth_date
	</select>
	
	<!-- 하단 정보 조회 -->
	<select id="scalen_info" parameterType="vo.shopvo.SCalenVO" resultType="vo.shopvo.SCalenVO">
		select 
		   sum(
		      case when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		           when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		      else 0 end 
		   ) as totamt,
		   sum(
		      case when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='ACC' then 1
		           when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='CAN' then -1
		      else 0 end
		      ) as totcnt,
		   sum(
		      case when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='ACC' then ifnull(discount,0)
		           when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='CAN' then 0-(ifnull(discount,0))
		      else 0 end 
		   ) as totdis,
		   count(
		         case when 
			         substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m')
			         and length(name)>1
			         then name
			      	 else null 
		      	 end
		   ) as totcust,
		   sum(
		      case when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		           when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		      else 0 end 
		   )-
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		      else 0 end 
		   ) as addamt,
		   sum(
		      case when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='ACC' then ifnull(etcamt,0)
		           when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='CAN' then 0-ifnull(etcamt,0)
		      else 0 end 
		   ) as tetcamt, -- 조제금액
		   sum(
		      case when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='ACC' and ifnull(etcamt,0)>0 then 1
		           when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='CAN' and ifnull(etcamt,0)>0 then -1
		      else 0 end
		   ) as tetccnt, -- 조제건수
		   sum(
		      case when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='ACC' then ifnull(etcamt,0)
		           when substr(auth_date,1,6)=date_format(cast(concat(#{yearmonth},'01') as date),'%Y%m') and paygubn='CAN' then 0-ifnull(etcamt,0)
		      else 0 end 
		   )-
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='ACC' then ifnull(etcamt,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='CAN' then 0-ifnull(etcamt,0)
		      else 0 end 
		   ) as addetc, -- 조제차이
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		      else 0 end 
		   ) as totamt1,
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='ACC' then 1
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='CAN' then -1
		      else 0 end
		      ) as totcnt1,
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='ACC' then ifnull(discount,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='CAN' then 0-(ifnull(discount,0))
		      else 0 end 
		   ) as totdis1,
		   count(
		        case when 
			         substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') 
			         and length(name)>1
		        then name
		      	else null 
		     	end
		   ) as totcust1,
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		      else 0 end 
		   )-
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		      else 0 end 
		   ) as addamt1,
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='ACC' then ifnull(etcamt,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='CAN' then 0-ifnull(etcamt,0)
		      else 0 end 
		   ) as tetcamt1, -- 조제금액1
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='ACC' and ifnull(etcamt,0)>0 then 1
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='CAN' and ifnull(etcamt,0)>0 then -1
		      else 0 end
		   ) as tetccnt1, -- 조제건수1
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='ACC' then ifnull(etcamt,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -1 month),'%Y%m') and paygubn='CAN' then 0-ifnull(etcamt,0)
		      else 0 end 
		   )-
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='ACC' then ifnull(etcamt,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='CAN' then 0-ifnull(etcamt,0)
		      else 0 end 
		   ) as addetc1, -- 조제차이1
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		      else 0 end 
		   ) as totamt2,
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='ACC' then 1
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='CAN' then -1
		      else 0 end
		      ) as totcnt2,
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='ACC' then ifnull(discount,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='CAN' then ifnull(discount,0)
		      else 0 end 
		   ) as totdis2,
		   count(
		        case when 
			        substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m')
			        and length(name)>1
		        then name
		      		else null 
		      	end
		   ) as totcust2,
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		      else 0 end 
		   )-
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -3 month),'%Y%m') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -3 month),'%Y%m') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		      else 0 end 
		   ) as addamt2,
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='ACC' then ifnull(etcamt,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='CAN' then 0-ifnull(etcamt,0)
		      else 0 end 
		   ) as tetcamt2, -- 조제금액2
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='ACC' and ifnull(etcamt,0)>0 then 1
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='CAN' and ifnull(etcamt,0)>0 then -1
		      else 0 end
		   ) as tetccnt2, -- 조제건수2
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='ACC' then ifnull(etcamt,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -2 month),'%Y%m') and paygubn='CAN' then 0-ifnull(etcamt,0)
		      else 0 end 
		   )-
		   sum(
		      case when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -3 month),'%Y%m') and paygubn='ACC' then ifnull(etcamt,0)
		           when substr(auth_date,1,6)=date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -3 month),'%Y%m') and paygubn='CAN' then 0-ifnull(etcamt,0)
		      else 0 end 
		   ) as addetc2 -- 조제차이2
		from 
		(
		  select auth_date,paygubn,total,etcamt,amt,vat,discount,birthday,sex,hp,name
		  from pos_payment_temp
		  where compcd=#{compcd} and auth_date = date_format(now(),'%Y%m%d')
		  union all
		  select auth_date,paygubn,total,etcamt,amt,vat,discount,birthday,sex,hp,name
		  from pos_payment
		  where compcd=#{compcd} and auth_date between concat(date_format(ADDDATE(cast(concat(#{yearmonth},'01') as date),interval -3 month),'%Y%m'),'01') and date_format(last_day(cast(concat(#{yearmonth},'01') as date)),'%Y%m%d')
		) ps
	</select>
</mapper>












