<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sinven">
	
	<!-- 재고 리스트 조회 -->
	<select id="sinven_list" parameterType="vo.shopvo.SInvenListVO" resultType="vo.shopvo.SInvenListVO">
		select dd.*
		from (
			select FLOOR((@rownum + 1 - 1)/ #{pagecnt} + 1) page,replace(FORMAT(@rownum := @rownum + 1,0),',','') as no,list.*
			from(
				select
					pc2.productid ,
					pc2.productname ,
					pc2.maker ,
					pc2.spec ,
					pc2.unit ,
					pc.stock ,
					pc.appropriatestock
				from pos_compstock pc
				inner join pos_compproduct pc2 
				on pc.productid = pc2.productid and pc.compcd = pc2.compcd 
				where 1 = 1
				and pc.compcd = #{compcd}
				<if test="search1 == 'all'">
					and concat(pc2.productname,pc2.productid, pc2.maker) like concat('%',#{searchInput},'%')
				</if>
				<if test="search1 == 'productname'">
					and pc2.productname like concat('%', #{searchInput}, '%')
				</if>
				<if test="search1 == 'maker'">
					and pc2.maker like concat('%', #{searchInput}, '%')
				</if>
				<if test="search1 == 'productid'">
					and pc2.productid like concat('%', #{searchInput}, '%')
				</if>
				<if test="search2 == 'incomedate'">
					and pc.purchasedate BETWEEN cast(#{searchDate1} as datetime) and cast(#{searchDate2} as datetime)
				</if>
				<if test="search2 == 'salesdate'">
					and pc.salesdate BETWEEN cast(#{searchDate1} as datetime) and cast(#{searchDate2} as datetime)
				</if>
				<if test="search3 != 'all'">
					and pc.accountcd = #{search3}
				</if>
			)list, (select @rownum := 0) r
		)dd
		where page=#{pageno}
	</select>
	
	<!-- 적정재고 반영 재고 리스트 조회 -->
	<select id="sinven_list2" parameterType="vo.shopvo.SInvenListVO" resultType="vo.shopvo.SInvenListVO">
		select dd.*
		from (
			select FLOOR((@rownum + 1 - 1)/ #{pagecnt} + 1) page,replace(FORMAT(@rownum := @rownum + 1,0),',','') as no,list.*
			from(
				select
					pc2.compcd,
					pc2.productid ,
					pc2.productname ,
					pc2.maker ,
					pc2.spec ,
					pc2.unit ,
					pc.stock ,
					usestock.usestock as appropriatestock
				from pos_compstock pc
				inner join pos_compproduct pc2 
				on pc.productid = pc2.productid and pc.compcd = pc2.compcd 
				left outer join (
					select ps.compcd, pc2.productid ,
						round(sum(pc.packingunit * ps.cnt)/(count(distinct ps.salesday) )* (#{percent}/100))* #{period} as usestock
					from pos_salelist ps
					inner join pos_compproductgroup pc 
				    on ps.compcd = pc.compcd and ps.productcd = pc.productcd
					inner join pos_compproduct pc2 
				    on pc.compcd = pc2.compcd and pc.productid = pc2.productid
					where 1 = 1
						and ps.salesday between cast(date_format(adddate(now(),-#{search4}), '%Y%m%d') as date) and cast(date_format(now(), '%Y%m%d') as date)
						and ps.compcd=#{compcd}
					group by ps.compcd, pc2.productid
				) usestock
				on pc.compcd = usestock.compcd and pc.productid = usestock.productid
				where 1 = 1
					and pc.compcd = #{compcd}
					<if test="search1 == 'all'">
						and concat(pc2.productname,pc2.productid, pc2.maker) like concat('%',#{searchInput},'%')
					</if>
					<if test="search1 == 'productname'">
						and pc2.productname like concat('%', #{searchInput}, '%')
					</if>
					<if test="search1 == 'maker'">
						and pc2.maker like concat('%', #{searchInput}, '%')
					</if>
					<if test="search1 == 'productid'">
						and pc2.productid like concat('%', #{searchInput}, '%')
					</if>
					<if test="search2 == 'incomedate'">
						and pc.purchasedate BETWEEN cast(#{searchDate1} as datetime) and cast(#{searchDate2} as datetime)
					</if>
					<if test="search2 == 'salesdate'">
						and pc.salesdate BETWEEN cast(#{searchDate1} as datetime) and cast(#{searchDate2} as datetime)
					</if>
					<if test="search3 != 'all'">
						and pc.accountcd = #{search3}
					</if>
			)list, (select @rownum := 0) r
		)dd
		where page=#{pageno}
	</select>
	
	<!-- 재고 건수 조회 -->
	<select id="count" parameterType="vo.shopvo.SInvenListVO" resultType="int">
		select count(*) from pos_compstock pc 
		inner join pos_compproduct pc2 
		      on pc.productid = pc2.productid 
		where 1=1 
		and pc.compcd = #{compcd}
		<if test="search1 == 'all'">
      		and concat(pc2.productname,pc2.productid, pc2.maker) like concat('%',#{searchInput},'%')
        </if>
        <if test="search1 == 'productname'">
        	and pc2.productname like concat('%', #{searchInput}, '%')
        </if>
        <if test="search1 == 'maker'">
        	and pc2.maker like concat('%', #{searchInput}, '%')
        </if>
        <if test="search1 == 'productid'">
        	and pc2.productid like concat('%', #{searchInput}, '%')
        </if>
        <if test="search2 == 'incomedate'">
        	and pc.purchasedate BETWEEN cast(#{searchDate1} as datetime) and cast(#{searchDate2} as datetime)
        </if>
        <if test="search2 == 'salesdate'">
        	and pc.salesdate BETWEEN cast(#{searchDate1} as datetime) and cast(#{searchDate2} as datetime)
        </if>
        <if test="search3 != 'all'">
        	and pc.accountcd = #{search3}
        </if>
	</select>
	
	<!-- tr 클릭 이벤트 상세보기 -->
	<select id="sinven_sel" parameterType="vo.shopvo.SInvenSelVO" resultType="vo.shopvo.SInvenSelVO">
		select replace(FORMAT(@rownum := @rownum+1,0),',','') as no, dd.*
		from(
			SELECT sat.* 
			from( 
			   select 
			      '판매' as stockgubn,
			      ifnull(pp.name,'') as name,
			      DATE_FORMAT(concat(ps.salesday, ps.salestime), '%y-%m-%d %H:%i:%s') as dat,
			      ps.cnt as cnt,
			      ps.price as price,
			      ps.discount as discount,
			      ps.total as total
			   from pos_salelist ps
			       inner join pos_payment pp
			          on ps.compcd = pp.compcd and ps.paymentcd = pp.paymentcd
			      inner join pos_compproductgroup pc 
			         on ps.compcd = pc.compcd and ps.productcd = pc.productcd 
			      inner join pos_compproduct pc2 
			         on pc.compcd = pc2.compcd and pc.productid = pc2.productid 
			   where 1=1
			       and ps.compcd=#{compcd}
			     and pc2.productid =#{productid}
			   union all 
			   select 
			      '매입' as stockgubn,
			      pa.accountname as name,
			      date_format(pc.purdt ,'%Y-%m-%d') as dat,
			      pc.cnt as cnt,
			      pc.price as price,
			      pc.discount as discount,
			      pc.total as total
			   from pos_comppuritem pc 
			      inner join pos_compproductgroup pc1 
			         on pc.compcd = pc1.compcd and pc.productcd = pc1.productcd 
			      inner join pos_compproduct pc2 
			         on pc1.compcd = pc2.compcd and pc1.productid = pc2.productid 
			      inner join pos_comppurchase pc3 
			         on pc.compcd = pc3.compcd and pc.purchasecd = pc3.purchasecd
			      inner join pos_account pa 
			         on pc.compcd = pa.compcd and pc1.compcd = pa.compcd and pc2.compcd = pa.compcd and pc3.compcd = pa.compcd and pc3.accountcd = pa.accountcd 
			   where 1=1
			       and pc1.compcd=#{compcd}
			     and pc1.productid =#{productid}
			) sat	
		)dd, (select @rownum :=0) r
	</select>
	
	<!-- 변경된 재고 저장하기 -->
	<update id="sinven_update" parameterType="vo.shopvo.SInvenVO">
		update pos_compstock pc set pc.stock = #{stock}, pc.appropriatestock =#{appropriatestock}
		where pc.compcd = #{compcd} and pc.productid = #{productid}
	</update>

</mapper>












