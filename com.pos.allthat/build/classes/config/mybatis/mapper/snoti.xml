<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="snoti">
	
	<!-- 공지사항 리스트 조회 -->
	<select id="snoti_list" parameterType="vo.NoticeVO" resultType="vo.NoticeVO">
		select dd.*
		from(
			select FLOOR((@rownum + 1 - 1)/ #{pagecnt} + 1) page, replace(FORMAT(@rownum := @rownum + 1, 0),',','') as no, list.*
			from(
				select
					pc.noticecode,
					pc.chaincode,
					pc.title,
					pc.content,
					pc.category,
					pc.regcd,
					pc.regdt,
					pc.readhit
				from pos_chainnotice pc
				inner join pos_compnotice pc2 on pc.noticecode = pc2.noticecode 
				where 1=1
				and pc2.compcd = #{compcd}
				<if test="search1 == 'all'">
					and concat(pc.title, pc.regcd) like concat('%',#{searchInput},'%')
				</if>
				<if test="search1 == 'title'">
					and pc.title like concat('%',#{searchInput},'%')
				</if>
				<if test="search1 == 'author'">
					and pc.regcd like concat('%',#{searchInput},'%')
				</if>
				and pc.regdt BETWEEN concat(#{searchDate1},'000000') and concat(#{searchDate2},'235959')
			)list, (select @rownum :=0) r
			order by category asc, regdt desc
		)dd
		where page=#{pageno}
	</select>
	
	<!-- 리스트 건수 조회 -->
	<select id="count" parameterType="vo.NoticeVO" resultType="int">
		select count(*)
		from pos_chainnotice pc
		inner join pos_compnotice pc2 on pc.noticecode = pc2.noticecode 
		where 1=1
		and pc2.compcd = #{compcd}
		<if test="search1 == 'title'">
			and pc.title like concat('%',#{searchInput},'%')
		</if>
		<if test="search1 == 'author'">
			and pc.regcd like concat('%',#{searchInput},'%')
		</if>
		and pc.regdt BETWEEN concat(#{searchDate1},'000000') and concat(#{searchDate2},'235959')
	</select>
	
	<!-- 읽음 표시(로그인 된 가맹점) -->
	<select id="readyn_update" parameterType="vo.NoticeVO">
		update pos_compnotice set readyn = 'Y', readdt = now()
		where noticecode = #{noticecode}
		and compcd = #{compcd}
	</select>
	
	<!-- 읽은 가맹점 수 구하기 -->
	<select id="ready" parameterType="vo.NoticeVO" resultType="int">
		select count(*)
		from pos_compnotice pc 
		where noticecode = #{noticecode}
		and readyn = 'Y'
	</select>
	
	<!-- 조회수 업데이트 -->
	<select id="readhit_update" parameterType="vo.NoticeVO">
		update pos_chainnotice set readhit = #{readhit}
		where noticecode = #{noticecode}
	</select>
</mapper>












