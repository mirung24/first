<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ssell2">
	
	<!-- 판매내역 리스트 조회 -->
	<select id="sell_list" parameterType="vo.shopvo.Ssell2VO" resultType="vo.shopvo.Ssell2VO">
		select dd.*
		from(
			select FLOOR((@rownum + 1 - 1)/ #{pagecnt} + 1) page, replace(FORMAT(@rownum := @rownum + 1, 0),',','') as no, list.*
			from(
				select ps.salesday,pp.productcd ,pp.productname ,pp.maker ,pp.unit ,pp.spec,pp.packingunit, 
				       ifnull(pp.purprice,0) as pirprice,
				       sum(case when po.paygubn='ACC' then ifnull(ps.cnt,0) when po.paygubn='CAN' then 0-ifnull(ps.cnt,0) else 0 end) as cnt,
				       sum(case when po.paygubn='ACC' then ifnull(ps.discount,0) when po.paygubn='CAN' then 0-ifnull(ps.discount,0) else 0 end) as discount,
				       sum(case when po.paygubn='ACC' then ifnull(ps.total,0) when po.paygubn='CAN' then 0-ifnull(ps.total,0) else 0 end) as total,
				       sum(case when po.paygubn='ACC' then ifnull(ps.cnt,0) when po.paygubn='CAN' then 0-ifnull(ps.cnt,0) else 0 end) * ifnull(pp.purprice,0) as purtot,
				       sum(case when po.paygubn='ACC' then ifnull(ps.total,0) when po.paygubn='CAN' then 0-ifnull(ps.total,0) else 0 end) - 
				       sum(case when po.paygubn='ACC' then ifnull(ps.cnt,0) when po.paygubn='CAN' then 0-ifnull(ps.cnt,0) else 0 end) * ifnull(pp.purprice,0) as margin
				from pos_salelist ps 
				   inner join pos_payment po
				      on ps.compcd = po.compcd and ps.paymentcd = po.paymentcd
				   inner join pos_compproductgroup pp 
				      on ps.compcd = pp.compcd and ps.productcd = pp.productcd and po.compcd = pp.compcd
				where 1=1 
					and ps.compcd=#{compcd}
					and salesday between #{searchDate1} and #{searchDate2}
					<if test="search1 == 'all'">
						and concat(pp.productcd, pp.productname) like concat('%',#{searchInput},'%')
					</if>
					<if test="search1 == 'productcd'">
						and pp.productcd like concat('%',#{searchInput},'%')
					</if>
					<if test="search1 == 'productname'">
						and pp.productname like concat('%',#{searchInput},'%')
					</if>
				group by ps.salesday,pp.productcd ,pp.productname ,pp.maker ,pp.unit ,pp.spec,pp.packingunit,pp.purprice
				order by ps.salesday desc
			)list, (select @rownum :=0) r
		)dd
		where page=#{pageno}
	</select>
	
	<!-- 판매내역 건수 조회 -->
	<select id="sell_count" parameterType="vo.shopvo.Ssell2VO" resultType="int">
		select count(*)
		from (
		select ps.salesday,pp.productcd ,pp.productname ,pp.maker ,pp.unit ,pp.spec,pp.packingunit,pp.purprice
		      from pos_salelist ps 
		         inner join pos_payment po
		            on ps.compcd = po.compcd and ps.paymentcd = po.paymentcd
		         inner join pos_compproductgroup pp 
		            on ps.compcd = pp.compcd and ps.productcd = pp.productcd and po.compcd = pp.compcd
		      where 1=1 
		         and ps.compcd=#{compcd}
				and salesday between #{searchDate1} and #{searchDate2}
		         <if test="search1 == 'all'">
					and concat(pp.productcd, pp.productname) like concat('%',#{searchInput},'%')
				</if>
				<if test="search1 == 'productcd'">
					and pp.productcd like concat('%',#{searchInput},'%')
				</if>
				<if test="search1 == 'productname'">
					and pp.productname like concat('%',#{searchInput},'%')
				</if>
		  group by ps.salesday,pp.productcd ,pp.productname ,pp.maker ,pp.unit ,pp.spec,pp.packingunit,pp.purprice
		) a
	</select>
</mapper>
