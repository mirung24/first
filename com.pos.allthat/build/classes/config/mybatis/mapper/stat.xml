<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="stat">
	
	<!-- 그래프 조회(월간 전체/otc) -->
	<select id="stat_mgrf" parameterType="String" resultType="vo.newvo.StatGraphVO">
		SELECT 
		   da.dd,
		   ifnull(dat.mtot,0) as mtot,
		   ifnull(dat.motc,0) as motc,
		   ifnull(dat.mtot2,0) as mtot2,
		   ifnull(dat.motc2,0) as motc2,
		   ifnull(dat.mavgtot,0) as mavgtot,
		   ifnull(dat.mavgotc,0) as mavgotc
		from(
		   select '01' as dd union all select '02' as dd union all select '03' as dd union all select '04' as dd union all select '05' as dd
		   union all select '06' as dd union all select '07' as dd union all select '08' as dd union all select '09' as dd union all select '10' as dd
		   union all select '11' as dd union all select '12' as dd union all select '13' as dd union all select '14' as dd union all select '15' as dd
		   union all select '16' as dd union all select '17' as dd union all select '18' as dd union all select '19' as dd union all select '20' as dd
		   union all select '21' as dd union all select '22' as dd union all select '23' as dd union all select '24' as dd union all select '25' as dd
		   union all select '26' as dd union all select '27' as dd union all select '28' as dd union all select '29' as dd union all select '30' as dd union all select '31' as dd
		)da
		left outer join( 
		   SELECT 
		      substr(auth_date,7,2) as dd,
		      sum(
		         case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(now(),'%Y%m') then total 
		              when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m')=date_format(now(),'%Y%m') then 0-total
		              else 0 end 
		      ) as mtot,
		      sum(
		         case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(now(),'%Y%m') then ifnull(amt,0)+ifnull(vat,0) 
		             when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m')=date_format(now(),'%Y%m') then 0-(ifnull(amt,0)+ifnull(vat,0))
		             else 0 end 
		      ) as motc,
		      sum(
		         case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(last_day(now() - interval 1 month),'%Y%m') then total 
		              when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m')=date_format(last_day(now() - interval 1 month),'%Y%m') then 0-total 
		              else 0 end 
		      ) as mtot2,
		      sum(
		         case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(last_day(now() - interval 1 month),'%Y%m') then ifnull(amt,0)+ifnull(vat,0)
		              when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m')=date_format(last_day(now() - interval 1 month),'%Y%m') then 0-(ifnull(amt,0)+ifnull(vat,0))
		              else 0 end 
		      ) as motc2,
		      sum(
		         case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(now(),'%Y%m') then total 
		              when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m')=date_format(now(),'%Y%m') then 0-total
		              else 0 end 
		      )/ifnull(count(distinct ps.compcd),1) as mavgtot,
		      sum(
		         case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(last_day(now() - interval 1 month),'%Y%m') then ifnull(amt,0)+ifnull(vat,0)
		              when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m')=date_format(last_day(now() - interval 1 month),'%Y%m') then 0-(ifnull(amt,0)+ifnull(vat,0))
		              else 0 end
		      )/ifnull(count(distinct ps.compcd),1) as mavgotc
		   from pos_payment ps
		      inner join pos_company pc on ps.compcd = pc.compcd 
		      inner join pos_chaincompany pc2 on pc.compcd = pc2.compcd and pc2.chaincode =#{chaincode}
		   where ps.auth_date between concat(date_format(last_day(now() - interval 1 month),'%Y%m'),'01') and date_format(now(),'%Y%m%d')
		   group by substr(auth_date,7,2)
		)dat on da.dd = dat.dd
	</select>
	
	<!-- 그래프 조회(주간 전체/otc) -->
	<select id="stat_wgrf" parameterType="String" resultType="vo.newvo.StatGraphVO">
		select 
		   wda.wday,
		   ifnull(w1.wtot,0) as wtot,
		   ifnull(w1.wotc,0) as wotc,
		   ifnull(w1.wavgtot,0) as wavgtot,
		   ifnull(w1.wavgotc,0) as wavgotc,
		   ifnull(w2.wtot2,0) as wtot2,
		   ifnull(w2.wotc2,0) as wotc2,
		   ifnull(w2.wavgtot2,0) as wavgtot2,
		   ifnull(w2.wavgotc2,0) as wavgotc2
		from (
		   select 1 as d ,'일' as wday
		   union all
		   select 2 as d ,'월' as wday
		   union all 
		   select 3 as d ,'화' as wday
		   union all 
		   select 4 as d ,'수' as wday
		   union all 
		   select 5 as d ,'목' as wday
		   union all 
		   select 6 as d ,'금' as wday
		   union all 
		   select 7 as d ,'토' as wday
		) wda 
		left outer join (
		   select 
		         DAYOFWEEK(date_format(ps.auth_date,'%Y%m%d')) as d,
		         sum(
		            case when ps.paygubn='ACC' then total 
		              when ps.paygubn='CAN' then 0-total
		              else 0 end 
		         ) as wtot,
		         sum(
		            case when ps.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		              when ps.paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		              else 0 end
		         ) as wotc,
		         round(sum(
		            case when ps.paygubn='ACC' then total 
		              when ps.paygubn='CAN' then 0-total
		              else 0 end   
		         )/ifnull(count(distinct ps.compcd),1)) as wavgtot,
		         round(sum(
		            case when ps.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		              when ps.paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		              else 0 end
		         )/ifnull(count(distinct ps.compcd),1)) as wavgotc
		   from pos_company pc 
		      inner join pos_chaincompany pc2 on pc.compcd = pc2.compcd and pc2.chaincode =#{chaincode}
		      inner join pos_payment ps on pc.compcd = ps.compcd 
		   where 1=1
		         and ps.auth_date between date_format(ADDDATE(now(),1-(DAYOFWEEK(now()))),'%Y%m%d') and date_format(now(),'%Y%m%d')
		   group by ps.auth_date    
		)w1 on wda.d = w1.d
		left outer join (
		   select
		         DAYOFWEEK(date_format(ps.auth_date,'%Y%m%d')) as d,
		         sum(
		            case when ps.paygubn='ACC' then total 
		              when ps.paygubn='CAN' then 0-total
		              else 0 end    
		         ) as wtot2,
		         sum(
		            case when ps.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		              when ps.paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		              else 0 end
		         ) as wotc2,
		         sum(
		            case when ps.paygubn='ACC' then total 
		              when ps.paygubn='CAN' then 0-total
		              else 0 end   
		         )/ifnull(count(distinct ps.compcd),1) as wavgtot2,
		         sum(
		            case when ps.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		              when ps.paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		              else 0 end
		         )/ifnull(count(distinct ps.compcd),1) as wavgotc2
		   from pos_company pc 
		      inner join pos_chaincompany pc2 on pc.compcd = pc2.compcd and pc2.chaincode =#{chaincode}
		      inner join pos_payment ps on pc.compcd = ps.compcd 
		   where 1=1
		         and ps.auth_date between date_format(ADDDATE(now(),1-7-(DAYOFWEEK(now()))),'%Y%m%d') and date_format(ADDDATE(now(),0-(DAYOFWEEK(now()))),'%Y%m%d')
		   group by ps.auth_date    
		)w2 on wda.d = w2.d
	</select>
	
	<!-- 그래프 조회(시간 전체/otc) -->
	<select id="stat_hgrf" parameterType="String" resultType="vo.newvo.StatGraphVO">
		SELECT 
		   tt.hour,
		   ifnull(dat.htot,0) as htot,
		   ifnull(dat.hotc,0) as hotc,
		   ifnull(dat.htot2,0) as htot2,
		   ifnull(dat.hotc2,0) as hotc2,
		   ifnull(dat.havgtot,0) as havgtot,
		   ifnull(dat.havgotc,0) as havgotc
		from(
		   select '00' as hour union all select '01' as hour union all select '02' as hour union all select '03' as hour union all select '04' as hour union all select '05' as hour
		   union all select '06' as hour union all select '07' as hour union all select '08' as hour union all select '09' as hour union all select '10' as hour
		   union all select '11' as hour union all select '12' as hour union all select '13' as hour union all select '14' as hour union all select '15' as hour
		   union all select '16' as hour union all select '17' as hour union all select '18' as hour union all select '19' as hour union all select '20' as hour
		   union all select '21' as hour union all select '22' as hour union all select '23' as hour 
		) tt   
		left outer join( 
		   SELECT 
		      auth_ti as hour,
		      sum(
		         case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(now(),'%Y%m') then total 
		              when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m')=date_format(now(),'%Y%m') then 0-total
		              else 0 end 
		      ) as htot,
		      sum(
		         case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(now(),'%Y%m') then ifnull(amt,0)+ifnull(vat,0) 
		              when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m')=date_format(now(),'%Y%m') then 0-(ifnull(amt,0)+ifnull(vat,0))
		              else 0 end 
		      ) as hotc,
		      sum(
		         case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(last_day(now() - interval 1 month),'%Y%m') then total 
		              when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m')=date_format(last_day(now() - interval 1 month),'%Y%m') then 0-total 
		              else 0 end 
		      ) as htot2,
		      sum(
		         case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(last_day(now() - interval 1 month),'%Y%m') then ifnull(amt,0)+ifnull(vat,0)  
		              when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m')=date_format(last_day(now() - interval 1 month),'%Y%m') then 0-(ifnull(amt,0)+ifnull(vat,0))
		              else 0 end 
		      ) as hotc2,
		      round(sum(case when ps.paygubn='ACC' then total 
		              when ps.paygubn='CAN' then 0-total
		              else 0 end
		      )/ifnull(count(distinct ps.compcd),1)) as havgtot,
		      round(sum(
		         case when ps.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) 
		              when ps.paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		              else 0 end
		      )/ifnull(count(distinct ps.compcd),1)) as havgotc
		   from pos_payment ps
		      inner join pos_company pc on ps.compcd = pc.compcd 
		      inner join pos_chaincompany pc2 on pc.compcd = pc2.compcd and pc2.chaincode =#{chaincode}
		   where ps.auth_date between concat(date_format(last_day(now() - interval 1 month),'%Y%m'),'01') and date_format(now(),'%Y%m%d')
		   group by auth_ti
		)dat on tt.hour = dat.hour
	</select>
	
</mapper>












