<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fran">
	
	<!-- 가맹점 관리 리스트 조회 -->
	<select id="fran_list" resultType="vo.newvo.CompanyListVO" parameterType="vo.newvo.CompanyListVO">
		select dd1.*
		from (
			select FLOOR((@rownum + 1 - 1) / #{pagecnt} + 1) page, replace(FORMAT(@rownum := @rownum+1,0),',','') as no, dat2.*
			from(
				select dat.*
			   from
			   (
			      SELECT *,case when mamt=0 then 0 else 
			         case when @pv = ifnull(mamt,0) then @vrank
			                     when @pv := ifnull(mamt,0) then @vrank := @vrank+1
			                     end
			      end as ranking
			      FROM 
			      (select pc.companyname ,
			                     pc.corporatenumber ,
			                     pc.president ,
			                     concat(pc.address, ' ', pc.address2) as addr,
			                     pc.tel ,
			                     pc.hp ,
			                     pc.email ,
			                     date_format(pc2.registerdate,'%Y.%m.%d') as rdate ,
			                     pc2.regdt ,
			                     pc2.registerdate ,
			                     ifnull(coms.namt,0) as namt,
			                     ifnull(coms.yamt,0) as yamt,
			                     ifnull(coms.mamt,0) as mamt,
			                     pc.compcd
			               from pos_company pc 
			                  inner join pos_chaincompany pc2 
			                     on pc.compcd = pc2.compcd and pc2.chaincode=#{chaincode}
			                   left outer join (
			                      select pc.compcd,
			                             sum(case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m%d') = date_format(now(),'%Y%m%d') then ps.total when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m%d') = date_format(now(),'%Y%m%d') then 0-ps.total else 0 end) namt,
			                             sum(case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m%d') = date_format(adddate(now(),-1),'%Y%m%d') then ps.total when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m%d') = date_format(adddate(now(),-1),'%Y%m%d') then 0-ps.total else 0 end) yamt,
			                             sum(case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m%d') between date_format(adddate(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then ps.total when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m%d') between date_format(adddate(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then 0-ps.total else 0 end) mamt
			                      from pos_company pc 
			                     inner join pos_chaincompany pc2 
			                        on pc.compcd = pc2.compcd and pc2.chaincode =#{chaincode}
			                      inner join pos_payment ps 
			                         on pc.compcd = ps.compcd and pc2.chaincode=#{chaincode} and pc2.compcd = ps.compcd 
			                       where date_format(ps.auth_date,'%Y%m%d') between date_format(adddate(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') 
			                       group by pc.compcd
			                       ) coms 
			                      on pc.compcd = coms.compcd
			               where 1=1 
			                order by ifnull(coms.mamt,0) desc,regdt asc
			      )dd ,(SELECT @vrank := 0, @pv := null) as r
			   )dat
			   where 1=1
			   <if test="search1 == 'all'">
			         and concat(companyname,corporatenumber,president) like concat('%',#{searchInput},'%')
			   </if>
			   <if test="search1 == 'companyname'">
		 	         and companyname like concat('%',#{searchInput},'%')
		 	   </if>
		 	   <if test="search1 == 'corporatenumber'">
		 	         and corporatenumber like concat('%',#{searchInput},'%')
		 	   </if>
		 	   <if test="search1 == 'president'">
		 	         and president like concat('%',#{searchInput},'%')
		 	   </if>
		 	   <if test="search2 == 'registerdate'">
		 	         and date_format(registerdate,'%Y%m%d') between #{searchDate1} and #{searchDate2}
		 	   </if>
		 	   <if test="search2 == 'regdt'">
		 	         and date_format(regdt,'%Y%m%d') between #{searchDate1} and #{searchDate2}
		 	   </if>
			) dat2, (select @rownum := 0 ) r    
			order by case when ranking=0 then 100000 else ranking end asc
		) dd1
		where page = #{pageno}
	</select>
	
	<!-- 가맹점 리스트 건수 조회 -->
	<select id="count" parameterType="vo.newvo.CompanyListVO" resultType="int">
		select count(*)
		from (
			select pc.companyname ,
		           pc.corporatenumber ,
		           pc.president ,
		           concat(pc.address, ' ', pc.address2) as addr,
		           pc.tel ,
		           pc.hp ,
		           pc.email ,
		           date_format(pc2.registerdate,'%Y.%m.%d') as rdate ,
		           pc2.regdt ,
		           pc2.registerdate ,
		           ifnull(coms.namt,0) as namt,
		           ifnull(coms.yamt,0) as yamt,
		           ifnull(coms.mamt,0) as mamt,
		           pc.compcd
		    from pos_company pc 
		    	inner join pos_chaincompany pc2 
		        	on pc.compcd = pc2.compcd and pc2.chaincode=#{chaincode}
		        left outer join (
		        	select pc.compcd,
		                   sum(case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m%d') = date_format(now(),'%Y%m%d') then ps.total when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m%d') = date_format(now(),'%Y%m%d') then 0-ps.total else 0 end) namt,
		                   sum(case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m%d') = date_format(adddate(now(),-1),'%Y%m%d') then ps.total when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m%d') = date_format(adddate(now(),-1),'%Y%m%d') then 0-ps.total else 0 end) yamt,
		                   sum(case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m%d') between date_format(adddate(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then ps.total when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m%d') between date_format(adddate(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then 0-ps.total else 0 end) mamt
		            from pos_company pc 
		                   inner join pos_chaincompany pc2 
		                   	on pc.compcd = pc2.compcd and pc2.chaincode =#{chaincode}
		                   inner join pos_payment ps 
		                         on pc.compcd = ps.compcd and pc2.chaincode=#{chaincode} and pc2.compcd = ps.compcd 
		                       where date_format(ps.auth_date,'%Y%m%d') between date_format(adddate(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') 
		                       group by pc.compcd
		                       ) coms 
		                      on pc.compcd = coms.compcd
		               where 1=1 
		                order by ifnull(coms.mamt,0) desc,regdt asc
		      )dd ,(SELECT @vrank := 0, @pv := null) as r
			   where 1=1
			   <if test="search1 == 'all'">
			         and concat(companyname,corporatenumber,president) like concat('%',#{searchInput},'%')
			   </if>
			   <if test="search1 == 'companyname'">
			         and companyname like concat('%',#{searchInput},'%')
			   </if>
			   <if test="search1 == 'corporatenumber'">
			         and corporatenumber like concat('%',#{searchInput},'%')
			   </if>
			   <if test="search1 == 'president'">
			         and president like concat('%',#{searchInput},'%')
			   </if>
			   <if test="search2 == 'registerdate'">
			         and date_format(registerdate,'%Y%m%d') between #{searchDate1} and #{searchDate2}
			   </if>
			   <if test="search2 == 'regdt'">
			         and date_format(regdt,'%Y%m%d') between #{searchDate1} and #{searchDate2}
			   </if>
	</select>
	
	<!-- 가맹점 관리 집계 -->
	<select id="fran_tt" resultType="vo.newvo.FranTotalVO" parameterType="String">
		select max(totcnt) as totcnt, -- 전체가맹점수
		       max(chrcnt) as chrcnt,-- 선택일자 가맹점수
		       max(newcnt) as newcnt,-- 신규 가맹점수
		       max(totamt1) as totamt1, -- 전체가맹점 매출
		       max(totcnt1) as totcnt1, -- 전체가맹점 건수
		       max(totamt2) as totamt2, -- 선택일자 매출
		       max(totcnt2) as totcnt2, -- 선택일자 건수
		       max(totamt3) as totamt3, -- 신규 가맹점 매출
		       max(totcnt3) as totcnt3  -- 신규 가맹점 건수
		from
		(
		   select 
		      count(*) as totcnt, 
		      0 as chrcnt,
		      ifnull(sum(case when DATE_FORMAT(pc2.registerdate ,'%Y%m%d') between DATE_FORMAT(ADDDATE(now(),-30) ,'%Y%m%d') and  DATE_FORMAT(now() ,'%Y%m%d') then 1 else 0 end),0) as newcnt,
		      0 as totamt1,
		      0 as totcnt1,
		      0 as totamt2,
		      0 as totcnt2,
		      0 as totamt3,
		      0 as totcnt3
		   from pos_company pc 
		   inner join pos_chaincompany pc2 on pc.compcd = pc2.compcd
		   where 1=1 and pc2.chaincode=#{chaincode}
		   union all    
		   select 
		      0 as totcnt,
		      count(DISTINCT case when date_format(ps.auth_date,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then pc.compcd
		      else 'ZZZZ' end)-1 as chrcnt,
		      0 as newcnt,
		      ifnull(sum(case when ps.paygubn='ACC' then ps.total
		                      when ps.paygubn='CAN' then 0-ps.total
		                     else 0 end),0) as totamt1,
		      count(ps.paymentcd) as totcnt1,
		      ifnull(sum(case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then ps.total
		                      when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then 0-ps.total
		                     else 0 end)
		      ,0) as totamt2,
		      ifnull(sum(case when ps.paygubn='ACC' and date_format(ps.auth_date,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then 1
		                      when ps.paygubn='CAN' and date_format(ps.auth_date,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then -1
		                    else 0 end)
		      ,0) as totcnt2,
		      ifnull(sum(case when ps.paygubn='ACC' and date_format(pc2.registerdate,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') and date_format(ps.auth_date,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then ps.total
		                     when ps.paygubn='CAN' and date_format(pc2.registerdate,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') and date_format(ps.auth_date,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then 0-ps.total
		                    else 0 end)
		      ,0) as totamt3,
		      ifnull(sum(case when ps.paygubn='ACC' and date_format(pc2.registerdate,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') and date_format(ps.auth_date,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then 1
		                      when ps.paygubn='CAN' and date_format(pc2.registerdate,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') and date_format(ps.auth_date,'%Y%m%d') between date_format(ADDDATE(now(),-30),'%Y%m%d') and date_format(now(),'%Y%m%d') then -1
		                      else 0 end)
		      ,0) as totcnt3
		   from pos_company pc 
		   inner join pos_chaincompany pc2 on pc.compcd = pc2.compcd
		   inner join pos_payment ps on pc.compcd = ps.compcd and pc2.compcd = ps.compcd 
		   where 1=1 and pc2.chaincode=#{chaincode}
		        and ps.auth_date between concat(date_format(now(),'%Y'),'0101') and date_format(now(),'%Y%m%d')
		) a
	</select>
	
	<!-- 등록 시 사업자번호 중복체크 -->
	<select id="corpnum_check" parameterType="String" resultType="int">
		select count(*) from pos_company where corporatenumber = #{corpnum}
	</select>
	
	<!-- 가맹점 관리 사업자 등록 -->
	<insert id="fran_insert" parameterType="vo.CompanyVO">
		insert into pos_company values(
                     fn_getuuid('COM'),
                     #{companyname},
                     #{corporatenumber},
                     #{president},
                     #{presidentcnt},
                     #{registerdate},
                     #{canceldate},
                     #{address},
                     #{address2},
                     #{tel},
                     #{hp},
                     #{fax},
                     #{email},
                     null,
                     null,
                     #{taxuseremail},
                     #{regcd},
                     now(),
                     'Y',
                     #{opendate},
                     #{remarks},
                     now(),
                     #{business},
                     #{sectors},
                     #{manager},
                     'Y'
      	)
	</insert>
	
	<!-- 담은 내용들 가져오기 -->
	<select id="comp_sel" parameterType="vo.CompanyVO" resultType="vo.CompanyVO">
		select * from pos_company where corporatenumber=#{corporatenumber}
	</select>
	
	<!-- 위에서 가져와서 chaincom에도 담기  -->
	<insert id="chaincom_ins">
		insert into pos_chaincompany values(
					 #{chaincode},
					 #{compcd},
					 #{registerdate},
					 #{regdt},
					 #{regcd},
					 #{canceldate},
					 #{remarks},
					 null
		)
	</insert>
	
	<!-- 선택한 내용 가져오기 -->
	<select id="compcd" parameterType="String" resultType="vo.CompanyVO">
		select * from pos_company where compcd=#{compcd}
	</select>
	
	<!-- 클릭한 tr 내용 가져오기 -->
	<select id="tr_sel" parameterType="String" resultType="vo.CompanyVO">
		SELECT 
			pc.compcd ,
			pc.corporatenumber ,
			pc.companyname ,
			pc.president ,
			pc.presidentcnt ,
			pc.address ,
			pc.address2 ,
			pc.tel ,
			pc.hp ,
			pc.fax ,
			pc.email ,
			pc.opendate ,
			pc2.registerdate ,
			pc.taxuseremail ,
			pc2.canceldate ,
			pc2.remarks,
			pc.business,
			pc.sectors,
			pc.manager 
		from pos_company pc
		inner join pos_chaincompany pc2 on pc.compcd=pc2.compcd 
		where 1=1
			and pc2.chaincode=#{chaincode}
			and pc.compcd=#{compcd}
	</select>
	
	<!-- 사용자 추가의 리스트 불러오기 -->
	<select id="ua_list" parameterType="String" resultType="vo.CompanyUserVO">
		select 
			name,
			userid,
			passwd,
			hp,
			ifnull(licence, '') as licence ,
			ifnull(date_format(joindate, '%Y-%m-%d'),'') as jo,
			ifnull(date_format(resigndate, '%Y-%m-%d'), '') as resign,
			level
		from pos_companyuser
		where compcd=#{dcompcd}
	</select>
	
	<select id="salesTally" parameterType="String" resultType="vo.newvo.SalesTallyVO">
		select sum(sa.total-ifnull(sj.total,0)) as total,
		       sum(case when sa.total-ifnull(sj.total,0) >1 then 1
		       else 0 end) as cnt,
		       round(sum(sa.total-ifnull(sj.total,0)) / datediff(now(),cast(concat(date_format(now(),'%Y'),'0101') as datetime))) as avgtot,
		       round(sum(case when sa.total-ifnull(sj.total,0) >1 then 1
		       else 0 end) / datediff(now(),cast(concat(date_format(now(),'%Y'),'0101') as datetime)),1) as avgcnt
		from pos_salelist sa 
		left outer join 
		   (
		      select compcd,salescd,ifnull(sum(cnt),0) as cnt,sum(ifnull(total,0)) as total
		      from pos_salesreject
		      group by compcd,salescd
		   )sj on sa.compcd = sj.compcd and sa.salescd = sj.salescd 
		where DATE_FORMAT(sa.salesdate,'%Y')=DATE_FORMAT(NOW(),'%Y') 
		     and sa.compcd=#{compcd}
	</select>
	
	<select id="salesHist" parameterType="vo.newvo.SalesHistVO" resultType="vo.newvo.SalesHistVO">
		select auth_date as salesdt,
			sum(case when paygubn='ACC' then total when paygubn='CAN' then 0-total else 0 end) as tot,
			sum(case when paygubn='ACC' then 1 when paygubn='CAN' then -1 else 0 end) as cnt   
		from (
			select compcd,auth_date,total,paygubn
			from pos_payment_temp ppt 
			where compcd=#{compcd} and auth_date = date_format(now(),'%Y%m%d')
			union all 
			select compcd,auth_date,total,paygubn
			from pos_payment ppt 
			where compcd=#{compcd} and auth_date between #{popSearch1} and #{popSearch2}
		)ps 
		group by auth_date
		order by auth_date desc
	</select>
	
	<select id="ua_idcheck" parameterType="vo.newvo.PopUpdateVO" resultType="int">
		select count(*) from pos_companyuser pc where compcd = #{compcd} and userid = #{ua_userid}
	</select>
	
	<update id="detUpdate" parameterType="vo.newvo.PopUpdateVO">
		update pos_company set companyname=#{pop_name},
							   corporatenumber=#{pop_copnum},
							   president=#{pop_pres},
							   presidentcnt=#{pop_pcnt},
							   opendate=#{pop_date1},
							   registerdate=#{pop_date2},
							   canceldate=#{pop_date3},
							   address=#{pop_addr},
							   address2=#{pop_addr2},
							   tel=#{pop_tel},
							   hp=#{pop_hp},
							   fax=#{pop_fax},
							   email=#{pop_email},
							   taxuseremail=#{pop_taxem},
							   remarks=#{pop_memo},
							   business=#{pop_business},
							   sectors=#{pop_sectors},
							   manager=#{pop_manager}
		where compcd=#{dcompcd}
	</update>
	
	<update id="detUpdate2" parameterType="vo.newvo.PopUpdateVO">
		update pos_chaincompany set registerdate=#{pop_date2},
							   		canceldate=#{pop_date3},
							   		remarks=#{pop_memo},
							   		upddt=now()
		where compcd=#{dcompcd}
	</update>
	
	<insert id="insert_ua" parameterType="vo.newvo.PopUpdateVO">
		insert into pos_companyuser(
			name ,
			userid ,
			passwd ,
			hp ,
			licence ,
			joindate ,
			resigndate ,
			level, 
			regcd,
			regdt,
			useyn,
			userseq,
			compcd
			)
			select 
			   #{ua_name} ,
			   #{ua_userid} ,
			   #{ua_passwd} ,
			   #{ua_hp} ,
			   #{ua_licence} ,
			   case when #{ua_date1}='' then null else #{ua_date1} end ,
			   case when #{ua_date2}='' then null else #{ua_date2} end ,
			   #{ua_level}, 
			   #{regcd},
			   now(),
			   'Y',
			   fn_getuuid('USR'),
			   #{dcompcd}
			   on duplicate KEY 
			   update 
			   name = #{ua_name} ,
			   passwd = #{ua_passwd} ,
			   hp = #{ua_hp} ,
			   licence = #{ua_licence} ,
			   joindate = case when #{ua_date1}='' then null else #{ua_date1} end ,
			   resigndate = case when #{ua_date2}='' then null else #{ua_date2} end ,
			   level = #{ua_level}
	</insert>
	
</mapper>





