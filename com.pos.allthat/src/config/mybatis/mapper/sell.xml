<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sell">
	
	<!-- 판매내역 리스트 조회 -->
	<select id="sell_list" parameterType="vo.newvo.SellListVO" resultType="vo.newvo.SellListVO">
	select dd1.*
	from(
		select FLOOR((@rownum + 1 - 1)/ #{pagecnt} + 1) page, replace(FORMAT(@rownum := @rownum+1,0),',','') as no, dat2.*
		from  (
			select concat(substr(pp.auth_date,1,4),'-',substr(pp.auth_date,5,2),'-',substr(pp.auth_date,7,2)) as auth_date ,
			      concat(substr(pp.auth_time,1,2),':',substr(pp.auth_time,3,2),':',substr(pp.auth_time,5,2)) as auth_time ,
			       pp.tid ,
			       pd.nickname as codename1 ,
			      pp.auth_no ,
			      case when pp.installments ='0' then '일시불' else pp.installments end installments,
			      pd2.codename as codename2 ,
			      pp.total ,
			      pp.vat ,
			      pp.discount ,
			      pc3.name  as salesman,
			      pc.companyname as name,
			      pp.productnames,
			      concat(pp.name, ifnull(pp.hp,'')),
			      pp.paymentcd
			from pos_payment pp
			   inner join pos_company pc on pp.compcd  = pc.compcd 
			   inner join pos_chaincompany pc2 on pc.compcd = pc2.compcd and pc2.chaincode =#{chaincode}
			   left outer join pos_cardlist pd on pp.cardgubn = pd.cardcd and pp.vancd = pd.vancode 
			   left outer join pos_code pd2 on pp.paymethod = pd2.code 
			   left outer join pos_companyuser pc3 on pp.salesid = pc3.userid 
			where 1=1 
			      and pp.auth_date between #{searchDate1} and #{searchDate2}
			      <if test="search1 == 'all'">
			      		<![CDATA[and concat(ifnull(pc.companyname,''), ifnull(pp.hp,'')) like concat('%',#{searchInput},'%')]]>
			      </if>
			      <if test="search1 == 'name'">
			      		<![CDATA[and pc.companyname like concat('%',#{searchInput},'%')]]>
			      </if>
			      <if test="search1 == 'hp'">
			      		<![CDATA[and pp.hp like concat('%',#{searchInput},'%')]]>
			      </if>
			      <if test="cardcnt > 0">
				     	and cardgubn in 
				     	<foreach item="item" index="index" collection="cardArr1" open="(" separator="," close=")">
				     		#{item,jdbcType=VARCHAR}
				     	</foreach>
				  </if>
			      <if test="paygubn == 'ACC'">
			      		<![CDATA[and pp.paygubn = #{paygubn}]]>
			      </if>
			      <if test="paygubn == 'CAN'">
			      		<![CDATA[and pp.paygubn = #{paygubn}]]>
			      </if>
			      <if test="paymethod == 'CARD'">
			      		<![CDATA[and pp.paymethod in ('D1','D4','AB','AC','J1','J4','A1','A2','A3','A4','A5','A6','A7','A8')]]>
			      </if>
			      <if test="paymethod == 'CMONEY'">
			      		<![CDATA[and pp.paymethod in ('B1','B2','B3','B4')]]>
			      </if>
			      <if test="paymethod == 'MONEY'">
			      		<![CDATA[and pp.paymethod in ('Q1','Q2')]]>
			      </if>
			      order by auth_date desc, auth_time desc
			)dat2, (select @rownum := 0 ) r
		)dd1
		where page=#{pageno}
		order by auth_date asc
	</select>
	
	<!-- 판매 건수 조회 -->
	<select id="sell_count" parameterType="vo.newvo.SellListVO" resultType="int">
		select count(*)
		from pos_payment pp
			   inner join pos_company pc on pp.compcd  = pc.compcd 
			   inner join pos_chaincompany pc2 on pc.compcd = pc2.compcd and pc2.chaincode =#{chaincode}
			   left outer join pos_cardlist pd on pp.cardgubn = pd.cardcd and pp.vancd = pd.vancode 
			   left outer join pos_code pd2 on pp.paymethod = pd2.code 
			   left outer join pos_companyuser pc3 on pp.salesid = pc3.userid 
			where 1=1 
			      and pp.auth_date between #{searchDate1} and #{searchDate2}
			      <if test="search1 == 'all'">
			      		<![CDATA[and concat(ifnull(pc.companyname,''), ifnull(pp.hp,'')) like concat('%',#{searchInput},'%')]]>
			      </if>
			      <if test="search1 == 'name'">
			      		<![CDATA[and pc.companyname like concat('%',#{searchInput},'%')]]>
			      </if>
			      <if test="search1 == 'hp'">
			      		<![CDATA[and pp.hp like concat('%',#{searchInput},'%')]]>
			      </if>
			      <if test="cardcnt > 0">
				     	and cardgubn in 
				     	<foreach item="item" index="index" collection="cardArr1" open="(" separator="," close=")">
				     		#{item,jdbcType=VARCHAR}
				     	</foreach>
				  </if>
			      <if test="paygubn == 'ACC'">
			      		<![CDATA[and pp.paygubn = #{paygubn}]]>
			      </if>
			      <if test="paygubn == 'CAN'">
			      		<![CDATA[and pp.paygubn = #{paygubn}]]>
			      </if>
			      <if test="paymethod == 'CARD'">
			      		<![CDATA[and pp.paymethod in ('D1','D4','AB','AC','J1','J4','A1','A2','A3','A4','A5','A6','A7','A8')]]>
			      </if>
			      <if test="paymethod == 'CMONEY'">
			      		<![CDATA[and pp.paymethod in ('B1','B2','B3','B4')]]>
			      </if>
			      <if test="paymethod == 'MONEY'">
			      		<![CDATA[and pp.paymethod in ('Q1','Q2')]]>
			      </if>
	</select>
	
	<!-- 판매상품 리스트 조회 -->
	<select id="sell_list2" parameterType="String" resultType="vo.newvo.SellList2VO">
		select replace(FORMAT(@rownum := @rownum+1,0),',','') as no, dat.*
		from(
			SELECT
				ps.paymentcd ,
				ps.productcd ,
				pc.maker ,
				pc.barcode ,
				pc.productname ,
				pc.unit ,
				pc.`size` ,
				pc.spec ,
				pc.packingunit ,
				ps.price ,
				ps.cnt ,
				ps.discount ,
				ps.total ,
				pc2.stock as stock
			from
				pos_salelist ps
			inner join pos_compproductgroup pc 
				on ps.compcd = pc.compcd and ps.productcd = pc.productcd
			left outer join pos_compstock pc2 
				on pc.compcd = pc2.compcd and pc.productid = pc2.productid
			where paymentcd =#{paymentcd}
		)dat, (select @rownum := 0 ) r
	</select>
</mapper>












