<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sincome">
	
	<!-- 입고관리 리스트 조회 -->
	<select id="sincome_list" parameterType="vo.shopvo.SIncomeListVO" resultType="vo.shopvo.SIncomeListVO">
		select dd1.* 
		from(
			select FLOOR((@rownum + 1 - 1)/ #{pagecnt} + 1) page, replace(FORMAT(@rownum := @rownum + 1,0),',','') as no,list.*
			from(
				SELECT 
				   po.purdate ,pa.accountname ,po.amt ,po.vat ,po.discount ,po.total ,po.purchasecd
				from pos_comppurchase po
				   inner join pos_account pa 
				      on po.compcd = pa.compcd and po.accountcd = pa.accountcd 
				where po.compcd=#{compcd} and purdate between concat(#{searchDate1},'000000') and concat(#{searchDate2},'235959')
				<if test="accountcd != 'all'">
					and po.accountcd =#{accountcd}
				</if>
				and po.purchasecd in(
					select purchasecd 
			   		from pos_comppuritem pu
			   		inner join pos_compproductgroup pg 
			   			on pu.compcd = pg.compcd and pu.productcd = pg.productcd 
			   		where pu.compcd=#{compcd} 
			   		and pu.purdt between concat(#{searchDate1},'000000') and concat(#{searchDate2},'235959')
			   		<if test="search1 == 'all'">
				      	and concat(pg.productname, pg.productcd, pg.maker) like concat('%',#{searchInput},'%')
				    </if>
			   		<if test="search1 == 'productid'">
			   			and pg.productcd like concat('%',#{searchInput},'%')
			   		</if>
			   		<if test="search1 == 'productname'">
			   			and pg.productname like concat('%',#{searchInput},'%')
			   		</if>
			   		<if test="search1 == 'maker'">
			   			and pg.maker like concat('%',#{searchInput},'%')
			   		</if>
				)
				order by purdate desc
			)list, (select @rownum := 0) r
		)dd1
		where page=#{pageno}
	</select>
	
	<!-- 입고 건수 조회 -->
	<select id="count" parameterType="vo.shopvo.SIncomeListVO" resultType="int">
		SELECT count(*) 
		from pos_comppurchase po
		   inner join pos_account pa 
		      on po.compcd = pa.compcd and po.accountcd = pa.accountcd 
		where po.compcd=#{compcd} and purdate between concat(#{searchDate1},'000000') and concat(#{searchDate2},'235959')
		<if test="accountcd != 'all'">
			and po.accountcd =#{accountcd}
		</if>
		and po.purchasecd in(
			select purchasecd 
	   		from pos_comppuritem pu
	   		inner join pos_compproductgroup pg 
	   			on pu.compcd = pg.compcd and pu.productcd = pg.productcd 
	   		where pu.compcd=#{compcd} 
	   		and pu.purdt between concat(#{searchDate1},'000000') and concat(#{searchDate2},'235959')
	   		<if test="search1 == 'all'">
		      	and concat(pg.productname, pg.productcd, pg.maker) like concat('%',#{searchInput},'%')
		    </if>
	   		<if test="search1 == 'productid'">
	   			and pg.productcd like concat('%',#{searchInput},'%')
	   		</if>
	   		<if test="search1 == 'productname'">
	   			and pg.productname like concat('%',#{searchInput},'%')
	   		</if>
	   		<if test="search1 == 'maker'">
	   			and pg.maker like concat('%',#{searchInput},'%')
	   		</if>
	   	)
	</select>
	
	<!-- 입고관리 상단집계 -->
	<select id="sincome_top" parameterType="vo.shopvo.SIncomeTopVO" resultType="vo.shopvo.SIncomeTopVO">
		SELECT 
		   ifnull(sum(total),0) as total,
		   ifnull(count(*),0) as cnt,
		   ifnull(count(distinct accountcd),0) as acnt
		from pos_comppurchase
		where compcd=#{compcd} and purdate between concat(date_format(now(),'%Y%m'),'01') and date_format(now(),'%Y%m%d') 
		union ALL 
		SELECT 
		   ifnull(sum(total),0) as total,
		   ifnull(count(*),0) as cnt,
		   ifnull(count(distinct accountcd),0) as acnt
		from pos_comppurchase
		where compcd=#{compcd} and purdate between concat(#{searchDate1},'000000') and concat(#{searchDate2},'235959')
	</select>
	
	<!-- 입고관리 상세보기 리스트 -->
	<select id="sincome_det" parameterType="vo.shopvo.SIncomeDetVO" resultType="vo.shopvo.SIncomeDetVO">
		select replace(FORMAT(@rownum := @rownum+1,0),',','') as no, dd.*
		from(
			select
				pp.productcd ,
				pp.productname ,
				pp.maker ,
				pp.packingunit ,
				pp.spec ,
				pp.unit ,
				pc.price ,
				pc.cnt ,
				pc.amt ,
				pc.discount ,
				pc.total ,
				pc.vat
			from
				pos_comppuritem pc
			inner join pos_compproductgroup pp 
			      on
				pc.compcd = pp.compcd
				and pc.productcd = pp.productcd
			where
				pc.purchasecd = #{purchasecd}
		)dd, (select @rownum :=0) r
	</select>
	
	<!-- 상품추가 리스트 조회 -->
	<select id="sincome_regiList" parameterType="vo.shopvo.SIncomeDetVO" resultType="vo.shopvo.SIncomeDetVO">
		select
			pc.productcd ,
			pc.productname ,
			pc.maker ,
			pc.spec ,
			pc.unit ,
			pc.packingunit ,
			pc.productid
		from
			pos_compproductgroup pc
		where compcd = #{compcd}
			<if test="search4 == 'productname'">
				and pc.productname like concat('%',#{searchInput2},'%')
			</if>
			<if test="search4 == 'productid'">
				and pc.productcd like concat('%',#{searchInput2},'%')
			</if>
			<if test="search4 == 'maker'">
				and pc.maker like concat('%',#{searchInput2},'%')
			</if>
		order by productname asc
	</select>
	
	<!-- 판매코드 채번(마스터 코드 생성) -->
	<select id="purchasecd" resultType="String">
		select fn_getuuid('PUR') as purchasecd
	</select>
	
	<!-- 입고등록(2) 상세등록 -->
	<select id="item_insert" parameterType="vo.shopvo.SIncomeVO">
		insert into pos_comppuritem(
			compcd,
			puritemcd,
			purchasecd,
			productcd,
			cnt,
			price,
			discount,
			amt,
			vat,
			total,
			tax,
			remarks,
			lotno,
			expirydate,
			packingunit,
			unit,
			spec,
			maker,
			purdt,
			regcd,
			regdt
		)
		values(
		   #{compcd},
		   fn_getuuid('PUI'),
		   #{purchasecd},
		   #{productcd},
		   #{cnt},
		   #{price},
		   #{discount},
		   #{amt},
		   #{vat},
		   #{total},
		   #{tax},
		   #{remarks},
		   #{lotno},
		   #{expirydate},
		   #{packingunit},
		   #{unit},
		   #{spec},
		   #{maker},
		   now(),
		   #{regcd},
		   now()
		)
	</select>
	
	<!-- 입고등록(3) 마스터 등록 -->
	<select id="purchase_insert" parameterType="vo.shopvo.SIncomeVO">
		insert into pos_comppurchase(
		   compcd,
		   purchasecd,
		   accountcd,
		   amt,
		   vat,
		   discount,
		   total,
		   remarks,
		   regcd,
		   regdt,
		   purdate,
		   invoiceno
		)
		select 
		   compcd,
		   purchasecd,
		   #{account2},
		   sum(amt),
		   sum(vat),
		   sum(discount),
		   sum(total),
		   #{remarks},
		   #{regcd},
		   now(),
		   now(),
		   null
		from pos_comppuritem 
		where compcd=#{compcd} and purchasecd=#{purchasecd}
		group by compcd, purchasecd
	</select>
	
	<!-- 입고등록(4) 재고 업데이트 -->
	<select id="stock_update" parameterType="vo.shopvo.SIncomeVO">
		insert into pos_compstock (
		   compcd,
		   productid,
		   stock,
		   purchasecnt,
		   purchasedate,
		   accountcd,
		   purchaseprice,
		   regcd,
		   regdt,
		   productcd
		)
		select
		   #{compcd},
		   #{productid},
		   #{cnt}*#{packingunit},
		   #{cnt}*#{packingunit},
		   now(),
		   #{account2},
		   #{price}/(#{packingunit}*#{cnt}),
		   #{regcd},
		   now(),
		   #{productcd}
		from pos_compproductgroup 
		where compcd= #{compcd} and productcd = #{productcd}
		on duplicate KEY 
		   update
		      stock = stock + (#{cnt}*#{packingunit}),
		      purchasecnt = #{cnt}*#{packingunit},
		      purchasedate = now(),
		      accountcd = #{account2},
		      purchaseprice = #{price}/(#{packingunit}*#{cnt}),
		      updatedate = now()
	</select>
	
	<!-- 입고서 삭제: 재고 업데이트 -->
	<select id="remove1" parameterType="vo.shopvo.SIncomeVO">
		insert into pos_compstock (
		   compcd,
		   productid,
		   stock,
		   purchasecnt,
		   purchasedate,
		   accountcd,
		   purchaseprice,
		   regcd,
		   regdt,
		   productcd
		)
		select
		   pc.compcd,
		   pc2.productid,
		   0-(pc.cnt * pc.packingunit),
		   0-(pc.cnt * pc.packingunit),
		   pc.purdt,
		   pc3.accountcd,
		   pc.price/(pc.packingunit*pc.cnt),
		   #{regcd},
		   now(),
		   pc2.productid
		from pos_comppuritem pc
			inner join pos_compproductgroup pc2 
				on pc.compcd = pc2.compcd and pc.productcd = pc2.productcd 
			inner join pos_comppurchase pc3 
				on pc.compcd = pc3.compcd and pc.purchasecd = pc3.purchasecd 
		where pc.compcd=#{compcd} 
			  and pc.purchasecd =#{purchasecd}
		on duplicate KEY 
		   update
		      oristock = stock,
		      stock = stock-#{cnts}*#{packingunit},
		      updatedate = now()
	</select>
	
	<!-- 입고서 삭제 : 상세 -->
	<delete id="remove2" parameterType="vo.shopvo.SIncomeVO">
		delete from pos_comppuritem
		where purchasecd = #{purchasecd}
	</delete>
	
	<!-- 입고서 삭제 : 마스터 -->
	<delete id="remove3" parameterType="vo.shopvo.SIncomeVO">
		delete from pos_comppurchase
		where purchasecd = #{purchasecd}
	</delete>
	
</mapper>












