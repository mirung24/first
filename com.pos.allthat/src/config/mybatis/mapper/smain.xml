<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="smain">
	
	<!-- 매출집계 -->
	<select id="main_info" parameterType="String" resultType="vo.shopvo.MainInfoVO">
		SELECT 
		   ifnull(sum(case when paygubn='ACC' then total when paygubn='CAN' then 0-total else 0 end), 0) as ytot,
		   ifnull(sum(case when substr(auth_date,1,6) = date_format(now(),'%Y%m') and paygubn='ACC' then total when substr(auth_date,1,6) = date_format(now(),'%Y%m') and paygubn='CAN' then 0-total else 0 end), 0) as mtot,
		   ifnull(sum(case when auth_date between date_format(ADDDATE(now(),1-(DAYOFWEEK(now()))),'%Y%m%d') and date_format(ADDDATE(now(),7-(DAYOFWEEK(now()))),'%Y%m%d') and paygubn='ACC' then total when auth_date between date_format(ADDDATE(now(),1-(DAYOFWEEK(now()))),'%Y%m%d') and date_format(ADDDATE(now(),7-(DAYOFWEEK(now()))),'%Y%m%d') and paygubn='CAN' then 0-total else 0 end), 0) as wtot,
		   ifnull(sum(case when substr(auth_date,1,8) = date_format(now(),'%Y%m%d') and paygubn='ACC' then total when substr(auth_date,1,8) = date_format(now(),'%Y%m%d') and paygubn='CAN' then 0-total else 0 end), 0) as ttot,
		   ifnull(sum(case when paygubn='ACC' then total when paygubn='CAN' then 0-total else 0 end - case when paygubn='ACC' then etcamt when paygubn='CAN' then 0-etcamt else 0 end), 0) as oytot,
		   ifnull(sum(case when substr(auth_date,1,6) = date_format(now(),'%Y%m') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) when substr(auth_date,1,6) = date_format(now(),'%Y%m') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0)) else 0 end), 0) as omtot,
		   ifnull(sum(case when paygubn ='ACC' and week(auth_date) = week(now()) then (ifnull(amt,0)+ifnull(vat,0)) when paygubn='CAN' and week(auth_date) = week(now()) then 0-(ifnull(amt,0)+ifnull(vat,0)) else 0 end),0) as owtot,
		   ifnull(sum(case when substr(auth_date,1,8) = date_format(now(),'%Y%m%d') then case when paygubn='ACC' then total when paygubn='CAN' then 0-total else 0 end - case when paygubn='ACC' then etcamt when paygubn='CAN' then 0-etcamt else 0 end else 0 end),0) as towtot,
		   count(distinct concat(hp,birthday,sex)) as ycnt,
		   count(distinct(case when substr(auth_date,1,6) = date_format(now(),'%Y%m') then concat(hp,birthday,sex) else null end)) as mcnt,
		   count(distinct(case when auth_date between date_format(ADDDATE(now(),1-(DAYOFWEEK(now()))),'%Y%m%d') and date_format(ADDDATE(now(),7-(DAYOFWEEK(now()))),'%Y%m%d') then concat(hp,birthday,sex) else null end)) as wcnt,
		   count(distinct(case when substr(auth_date,1,8) = date_format(now(),'%Y%m%d') then concat(hp,birthday,sex) else null end)) as twcnt
		from   (
		     select paygubn,auth_date,total,etcamt,amt,vat,hp,sex,birthday
		     from pos_payment_temp
		     where compcd =#{compcd}
		       and auth_date = date_format(now(), '%Y%m%d') 
		     union all
		     select paygubn,auth_date,total,etcamt,amt,vat,hp,sex,birthday
		     from pos_payment
		     where compcd =#{compcd}
		       and auth_date between concat(date_format(now(),'%Y'),'0101') and date_format(now(),'%Y%m%d')
		  ) a
	</select>
	
	<!-- 고객 집계 -->
	<select id="main_cust" parameterType="String" resultType="vo.shopvo.MainInfoVO">
		select 
		   count(*) as tcust,
		   ifnull(count(distinct (case when ps.sex='M' then concat(ps.sex,ps.birthday,ps.name) else null end)),0) as mcust,
		   ifnull(count(distinct (case when ps.sex='F' then concat(ps.sex,ps.birthday,ps.name) else null end)),0) as fcust,
		   ifnull(sum(case when ps.paygubn='ACC' and ps.auth_date between date_format(ADDDATE(now(),1-(DAYOFWEEK(now()))),'%Y%m%d') and date_format(ADDDATE(now(),7-(DAYOFWEEK(now()))),'%Y%m%d') then 1 
		                    when ps.paygubn='CAN' and ps.auth_date between date_format(ADDDATE(now(),1-(DAYOFWEEK(now()))),'%Y%m%d') and date_format(ADDDATE(now(),7-(DAYOFWEEK(now()))),'%Y%m%d') then -1   
		                   else 0 end), 0) as wcust,
		   ifnull(count(distinct (case when ps.auth_date = date_format(now(),'%Y%m%d') then concat(ps.name) else null end)), 0) as dcust,
		   sum(case when ps.paygubn='ACC' and ps.auth_date=date_format(now(),'%Y%m%d') then 1 when ps.paygubn='CAN' and ps.auth_date=date_format(now(),'%Y%m%d') then -1 else 0 end) as dvisit, -- 추가(오늘의 방문수)
		   ifnull((SELECT 
		      SUBSTRING(group_concat(best order by pcnt desc),1,3) as best
		      from(
		         select  concat(concat(substr(date_format(now(),'%Y')-ps.birthday,1,1),'0'),ps.sex) as best,count(*) as pcnt
		         from pos_company pc 
		         inner join pos_payment ps on pc.compcd = ps.compcd 
		         where 1=1 and ps.auth_date between concat(date_format(now(),'%Y'),'0101') and date_format(now(),'%Y%m%d') and ps.compcd=#{compcd}
		         and ps.sex in('M','F') and length(ps.birthday)>=4
		         group by concat(concat(substr(date_format(now(),'%Y')-ps.birthday,1,1),'0'),ps.sex)
		      ) A       
		   ),'-') as best
		from pos_company pc 
		inner join 
		   (
		      select compcd,sex,auth_date,birthday,name,paygubn
		      from pos_payment_temp
		      where compcd=#{compcd} and auth_date = date_format(now(), '%Y%m%d')
		      union all
		      select compcd,sex,auth_date,birthday,name,paygubn
		      from pos_payment
		      where compcd=#{compcd} and auth_date between concat(date_format(now(),'%Y'),'0101') and date_format(now(),'%Y%m%d')
		   )  ps on pc.compcd = ps.compcd 
		where 1=1
		   and pc.compcd=#{compcd}
	</select>
	
	<!-- 그래프 조회 -->
	<select id="main_grf" parameterType="String" resultType="vo.newvo.MainGraphVO">
		SELECT wda.wday,
		   round(ifnull(w1.tot,0)/1000) as tot1,
		   round(ifnull(w2.tot,0)/1000) as tot2,
		   round(ifnull(w1.amt,0)/1000) as amt1,
		   round(ifnull(w2.amt,0)/1000) as amt2,
		   ifnull(w1.cust,0) as cust1,
		   ifnull(w2.cust,0) as cust2
		from (
		   select 1 as d ,'일' as wday
		   union all
		   select 2 as d ,'월' as wday
		   union all 
		   select 3 as d ,'화' as wday
		   union all 
		   select 4 as d ,'수' as wday
		   union all 
		   select 5 as d ,'목' as wday
		   union all 
		   select 6 as d ,'금' as wday
		   union all 
		   select 7 as d ,'토' as wday
		) wda 
		left outer join
		(
		   select
		         DAYOFWEEK(date_format(ps.auth_date,'%Y%m%d')) as d,
		         sum(case when paygubn='ACC' then ifnull(total,0) when paygubn='CAN' then 0-ifnull(total,0) else 0 end) as tot,
		         sum(case when paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) when paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0)) else 0 end) as amt,
		         -- count(distinct(concat(ps.birthday,ps.sex,ps.hp))) as cust
		         count(distinct paymentcd) as cust
		   from pos_company pc 
		      inner join 
		      (
		         select paymentcd,compcd,auth_date,paygubn,total,amt,vat,birthday,sex,hp
		         from pos_payment_temp
		         where compcd=#{compcd} and auth_date = date_format(now(),'%Y%m%d') 
		         union all
		         select paymentcd,compcd,auth_date,paygubn,total,amt,vat,birthday,sex,hp
		         from pos_payment 
		         where compcd=#{compcd} and auth_date between date_format(ADDDATE(now(),1-(DAYOFWEEK(now()))),'%Y%m%d') and date_format(now(),'%Y%m%d')
		      ) ps on pc.compcd = ps.compcd 
		   where 1=1 and pc.compcd=#{compcd}
		   group by ps.auth_date    
		)w1 on wda.d = w1.d
		left outer join
		(
		   select
		         DAYOFWEEK(date_format(ps.auth_date,'%Y%m%d')) as d,
		         ifnull(sum(case when paygubn='ACC' then ifnull(total,0) when paygubn='CAN' then 0-ifnull(total,0) else 0 end),0) as tot,
		         ifnull(sum(case when paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) when paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0)) else 0 end),0) as amt,
		         -- count(distinct(concat(ps.birthday,ps.sex,ps.hp))) as cust
		         count(distinct paymentcd) as cust
		   from pos_company pc 
		      inner join pos_payment ps on pc.compcd = ps.compcd 
		   where 1=1 and pc.compcd=#{compcd}
		         and ps.auth_date between date_format(ADDDATE(ADDDATE(now(),1-(DAYOFWEEK(now()))), interval -1 week),'%Y%m%d') 
		         and date_format(ADDDATE(now(),0-(DAYOFWEEK(now()))),'%Y%m%d')
		   group by ps.auth_date    
		)w2 on wda.d = w2.d
		order by wda.d
	</select>
	
	<!-- 주간 best 상품 리스트 조회 -->
	<select id="best_prod" parameterType="vo.shopvo.SIncomeDetVO" resultType="vo.shopvo.MainChartVO1">
		select dat.*
		from(
		   select replace(FORMAT(@rownum := @rownum+1,0),',','') as no,sa.*
		   from(
		   select  pc3.productid , pc3.productname , ifnull(sum(case when pp.paygubn='ACC' then ifnull(ps.total,0) when pp.paygubn='CAN' then 0-ifnull(ps.total,0) else 0 end),0) as total,
		           ifnull(sum(case when pp.paygubn='ACC' then ifnull(ps.cnt,0) when pp.paygubn='CAN' then 0-ifnull(ps.cnt,0) else 0 end),0) as tcnt
		   from pos_salelist ps
		      inner join pos_payment pp 
		         on ps.compcd = pp.compcd and ps.paymentcd = pp.paymentcd 
		      inner join pos_company pc 
		         on ps.compcd = pc.compcd and pp.compcd = pc.compcd 
		       inner join pos_compproductgroup pc2 
		          on ps.productcd = pc2.productcd and ps.compcd = pc2.compcd and pc.compcd = pc2.compcd and pp.compcd = pc2.compcd 
		       inner join pos_compproduct pc3 
		          on pc.compcd = pc3.compcd and pc2.compcd = pc3.compcd and pc2.productid = pc3.productid
		   where  1=1 and pc.compcd=#{compcd}
		            and ps.salesday between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
		            and pc3.productid not in(select productid from pos_comppassproduct where compcd = #{compcd})
		   group by pc3.productid, pc3.productname
		   order by 
		   		<if test="wprodsel.equals('aaaa')">
		   			sum(case when pp.paygubn='ACC' then ifnull(ps.total,0) when pp.paygubn='CAN' then 0-ifnull(ps.total,0) else 0 end) desc
		   		</if>
		   		<if test="wprodsel == 'bbbb'">
		   			sum(case when pp.paygubn='ACC' then ifnull(ps.cnt,0) when pp.paygubn='CAN' then 0-ifnull(ps.cnt,0) else 0 end) desc
		   		</if>
		   )sa, (select @rownum:=0) r
		   <![CDATA[   
		   where total > 0
		)dat
		where dat.no<=10
		]]>
	</select>
	
	<!-- 주간 worst 상품 리스트 조회 -->
	<select id="worst_prod" parameterType="vo.shopvo.SIncomeDetVO" resultType="vo.shopvo.MainChartVO2">
		select dat.*
		from(
		   select replace(FORMAT(@rownum := @rownum+1,0),',','') as no,sa.*
		   from(
		   select  pc3.productid , pc3.productname , ifnull(sum(case when pp.paygubn='ACC' then ifnull(ps.total,0) when pp.paygubn='CAN' then 0-ifnull(ps.total,0) else 0 end),0) as total,
		           ifnull(sum(case when pp.paygubn='ACC' then ifnull(ps.cnt,0) when pp.paygubn='CAN' then 0-ifnull(ps.cnt,0) else 0 end),0) as tcnt
		   from pos_salelist ps
		      inner join pos_payment pp 
		         on ps.compcd = pp.compcd and ps.paymentcd = pp.paymentcd 
		      inner join pos_company pc 
		         on ps.compcd = pc.compcd and pp.compcd = pc.compcd 
		       inner join pos_compproductgroup pc2 
		          on ps.productcd = pc2.productcd and ps.compcd = pc2.compcd and pc.compcd = pc2.compcd and pp.compcd = pc2.compcd 
		       inner join pos_compproduct pc3 
		          on pc.compcd = pc3.compcd and pc2.compcd = pc3.compcd and pc2.productid = pc3.productid
		   where  1=1 and pc.compcd=#{compcd}
		            and ps.salesday between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
		            and pc3.productid not in(select productid from pos_comppassproduct where compcd = #{compcd})
		   group by pc3.productid, pc3.productname
		   order by 
		   		<if test="wprodsel.equals('aaaa')">
		   			sum(case when pp.paygubn='ACC' then ifnull(ps.total,0) when pp.paygubn='CAN' then 0-ifnull(ps.total,0) else 0 end) asc
		   		</if>
		   		<if test="wprodsel == 'bbbb'">
		   			sum(case when pp.paygubn='ACC' then ifnull(ps.cnt,0) when pp.paygubn='CAN' then 0-ifnull(ps.cnt,0) else 0 end) asc
		   		</if>
		   )sa, (select @rownum:=0) r  
		   <![CDATA[ 
		   where tcnt > 0
		)dat
		where dat.no <= 10
		]]>
	</select>
	
	<!-- 주간 신규 내방 고객 -->
	<select id="new_cust" parameterType="vo.shopvo.SIncomeDetVO" resultType="vo.shopvo.MainChartVO3">
		<![CDATA[
		select dat.*
		from(
			select replace(format(@rownum:=@rownum+1,0),',','') as no, sa.*
			from(
				SELECT peo.*
				from
				(
				   select
				      ps.birthday,ps.name,ps.hp,
				      concat(substr(cast( date_format(now(),'%Y') as signed)-cast(ps.birthday as signed),1,1),'0',ps.sex) as cust
				      ,sum(ps.total) as total,
				      date_format(cast(max(ps.auth_date) as date),'%Y.%m.%d') as visday,
				      concat(substr(max(concat(ps.auth_date,ps.auth_time)),9,2),':',substr(max(concat(ps.auth_date,ps.auth_time)),11,2),':',substr(max(concat(ps.auth_date,ps.auth_time)),13,2)) as vistime
				   from pos_company pc 
				      inner join pos_payment ps on pc.compcd = ps.compcd 
				   where 1=1
				   		 and pc.compcd=#{compcd}
				         and ps.auth_date between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
				         and ps.birthday is not null and ps.sex is not null
				   group by ps.birthday,ps.name,ps.hp,concat(substr(cast( date_format(now(),'%Y') as signed)-cast(ps.birthday as signed),1,1),'0',ps.sex)
				) peo
				left outer JOIN 
				   (
				   select
				      ps.birthday,ps.name,ps.hp,sum(ps.total) as total 
				   from pos_company pc 
				      inner join pos_payment ps on pc.compcd = ps.compcd 
				   where 1=1
				   		 and pc.compcd=#{compcd}
				         and ps.auth_date between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d')
				         and ps.birthday is not null and ps.sex is not null
				   group by ps.birthday,ps.name,ps.hp
				   ) peo1
				   on concat(peo.birthday,peo.name,peo.hp) = concat(peo1.birthday,peo1.name,peo1.hp)
				where peo1.birthday is NULL
			)sa, (select @rownum:=0) r
		)dat
		where dat.no<=10
		]]>
	</select>
	
	<!-- 주간 매출 상위 상품 -->
	<select id="top_prod" parameterType="vo.shopvo.SIncomeDetVO" resultType="vo.shopvo.MainChartVO4">
		<![CDATA[
		select name
		from(
		   select list1.name ,replace(FORMAT(@rownum := @rownum+1,0),',','') as no
		   FROM
		   (
		      SELECT concat(ww.wday,'요일') as name
		      from
		      (
		         SELECT wda.wday,
		            round(ifnull(w1.tot,0)/1000) as tot1,
		            round(ifnull(w1.amt,0)/1000) as amt1
		         from (
		         select 2 as d ,'월' as wday
		         union all
		         select 3 as d ,'화' as wday
		         union all
		         select 4 as d ,'수' as wday
		         union all
		         select 5 as d ,'목' as wday
		          union all
		          select 6 as d ,'금' as wday
		          union all
		          select 7 as d ,'토' as wday
		          union all
		          select 1 as d ,'일' as wday
		         ) wda
		         left outer join
		         (
		            select
		                  DAYOFWEEK(date_format(ps.auth_date,'%Y%m%d')) as d,
		                  sum(case when ps.paygubn='ACC' then total when ps.paygubn='CAN' then 0-total else 0 end) as tot,
		                  sum(case when ps.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) when ps.paygubn='CAN' then 0-ifnull(amt,0)+ifnull(vat,0) else 0 end) as amt,
		                  count(distinct(concat(ps.birthday,ps.sex,ps.hp))) as cust
		            from pos_company pc
		               inner join pos_payment ps on pc.compcd = ps.compcd
		            where 1=1 and pc.compcd=#{compcd}
		                  and ps.auth_date between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
		            group by DAYOFWEEK(date_format(ps.auth_date,'%Y%m%d'))
		         )w1 on wda.d = w1.d
		         order by tot1 desc
		      ) ww ,(select @rownum:=0) r
		   )list1
		   union all
		   select ifnull(list2.name,'-') ,replace(FORMAT(@rownum1 := @rownum1+1,0),',','') as no
		   FROM
		   (
		      SELECT ifnull(pp.pname, '-') as name
			  from (select 'pname' as gb) a
			  left outer join (
			       select pc3.productname as pname,sum(case when pp.paygubn='ACC' then ifnull(ps.amt,0)+ifnull(ps.vat,0) when pp.paygubn='CAN' then 0-ifnull(ps.amt,0)+ifnull(ps.vat,0) else 0 end) as pamt
				    from pos_salelist ps
				       inner join pos_company pc
				          on ps.compcd = pc.compcd
				        inner join pos_compproductgroup pc2
				           on ps.productcd = pc2.productcd and ps.compcd = pc2.compcd and pc.compcd = pc2.compcd
				        inner join pos_compproduct pc3
				           on pc.compcd = pc3.compcd and pc2.compcd = pc3.compcd and pc2.productid = pc3.productid
				        inner join pos_payment pp
				           on ps.compcd = pp.compcd and ps.paymentcd = pp.paymentcd
				    where  1=1 and pc.compcd=#{compcd}
				         and ps.salesday between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
				         and pc3.productid not in(select productid from pos_comppassproduct where compcd=#{compcd})
				    group by pc3.productid , pc3.productname
				    order by sum(
				       case when pp.paygubn='ACC' then ifnull(ps.amt,0)+ifnull(ps.vat,0) when pp.paygubn='CAN' then 0-ifnull(ps.amt,0)+ifnull(ps.vat,0) else 0 end
				        ) desc
			  ) pp on 1=1
			  ,(select @rownum1:=0) r
		   ) list2
		   union all
		   select list3.name ,replace(FORMAT(@rownum2 := @rownum2+1,0),',','') as no
		   FROM
		   (
		   select ww.ti  as name
		   from(
		      SELECT tt.ti,
		            round(ifnull(w1.tot,0)/1000) as tot1,
		            round(ifnull(w1.amt,0)/1000) as amt1
		         from (
		         select '01' as d ,'AM 01:00' as ti
		         union all
		         select '02' as d ,'AM 02:00' as ti
		         union all
		         select '03' as d ,'AM 03:00' as ti
		         union all
		         select '04' as d ,'AM 04:00' as ti
		         union all
		         select '05' as d ,'AM 05:00' as ti
		         union all
		         select '06' as d ,'AM 06:00' as ti
		         union all
		         select '07' as d ,'AM 07:00' as ti
		         union all
		         select '08' as d ,'AM 08:00' as ti
		         union all
		         select '09' as d ,'AM 09:00' as ti
		         union all
		         select '10' as d ,'AM 10:00' as ti
		         union all
		         select '11' as d ,'AM 11:00' as ti
		         union all
		         select '12' as d ,'AM 12:00' as ti
		         union all
		         select '13' as d ,'PM 01:00' as ti
		         union all
		         select '14' as d ,'PM 02:00' as ti
		         union all
		         select '15' as d ,'PM 03:00' as ti
		         union all
		         select '16' as d ,'PM 04:00' as ti
		         union all
		         select '17' as d ,'PM 05:00' as ti
		         union all
		         select '18' as d ,'PM 06:00' as ti
		         union all
		         select '19' as d ,'PM 07:00' as ti
		         union all
		         select '20' as d ,'PM 08:00' as ti
		         union all
		         select '21' as d ,'PM 09:00' as ti
		         union all
		         select '22' as d ,'PM 10:00' as ti
		         union all
		         select '23' as d ,'PM 11:00' as ti
		         union all
		         select '24' as d ,'AM 00:00' as ti
		         ) tt
		         left outer join
		         (
		         select
		                  ps.auth_ti as d,
		                  sum(case when ps.paygubn='ACC' then total when ps.paygubn='CAN' then 0-total else 0 end) as tot,
		                  sum(case when ps.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) when ps.paygubn='CAN' then 0-ifnull(amt,0)+ifnull(vat,0) else 0 end) as amt
		            from pos_company pc
		               inner join pos_payment ps on pc.compcd = ps.compcd
		            where 1=1 and pc.compcd=#{compcd}
		                  and ps.auth_date between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
		            group by ps.auth_ti
		         )w1 on tt.d = w1.d
		         order by tot1 desc
		      ) ww ,(select @rownum2:=0) r
		      )list3
		      union all
		      select list4.name,replace(FORMAT(@rownum3 := @rownum3+1,0),',','') as no
		      from(
		         SELECT ifnull(ss.name,'-') as name
				  from (select 'age' as age) a
				  left outer join(
				  	  select
				       concat(substr(cast( date_format(now(),'%Y') as signed)-cast(ps.birthday as signed),1,1),'0',ps.sex) as name,
				       sum(case when ps.paygubn='ACC' then total when ps.paygubn='CAN' then 0-total else 0 end) as tot
				    from pos_company pc
				       inner join pos_payment ps on pc.compcd = ps.compcd
				    where 1=1 and pc.compcd=#{compcd}
				          and ps.auth_date between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
				          and length(ps.birthday)>=4 and length(ps.sex)>=1
				    group by concat(substr(cast( date_format(now(),'%Y') as signed)-cast(ps.birthday as signed),1,1),'0',ps.sex)
				    order by sum(case when ps.paygubn='ACC' then total when ps.paygubn='CAN' then 0-total else 0 end) desc
				     )ss on 1=1
				     ,(select @rownum3:=0) r
		      )list4
		) list
		where no=1
		]]>
	</select>
	
	<!-- 주간 매출 하위 상품 -->
	<select id="sub_prod" parameterType="vo.shopvo.SIncomeDetVO" resultType="vo.shopvo.MainChartVO4">
		<![CDATA[
		SELECT name
		from(
		   select list1.name ,replace(FORMAT(@rownum := @rownum+1,0),',','') as no
		   FROM 
		   (
		      SELECT concat(ww.wday,'요일') as name
		      from 
		      (
		         SELECT wda.wday,
		            round(ifnull(w1.tot,0)/1000) as tot1,
		            round(ifnull(w1.amt,0)/1000) as amt1
		         from (
		         select 2 as d ,'월' as wday
		         union all 
		         select 3 as d ,'화' as wday
		         union all 
		         select 4 as d ,'수' as wday
		         union all 
		         select 5 as d ,'목' as wday
		          union all 
		          select 6 as d ,'금' as wday
		          union all 
		          select 7 as d ,'토' as wday
		          union all 
		          select 1 as d ,'일' as wday
		         ) wda 
		         left outer join
		         (
		            select
		                  DAYOFWEEK(date_format(ps.auth_date,'%Y%m%d')) as d,
		                  sum(case when ps.paygubn='ACC' then total when ps.paygubn='CAN' then 0-total else 0 end) as tot,
		                  sum(case when ps.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) when ps.paygubn='CAN' then 0-ifnull(amt,0)+ifnull(vat,0) else 0 end) as amt,
		                  count(distinct(concat(ps.birthday,ps.sex,ps.hp))) as cust
		            from pos_company pc 
		               inner join pos_payment ps on pc.compcd = ps.compcd 
		            where 1=1 and pc.compcd=#{compcd}
		                  and ps.auth_date between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
		            group by DAYOFWEEK(date_format(ps.auth_date,'%Y%m%d'))  
		         )w1 on wda.d = w1.d
		         order by tot1 asc 
		      ) ww ,(select @rownum:=0) r   
		   )list1
		   union all
		   select list2.name ,replace(FORMAT(@rownum1 := @rownum1+1,0),',','') as no
		   FROM 
		   (
		      SELECT ifnull(pp.pname, '-') as name
			  from (select 'pname' as gb) a 
			  left outer join(
			        select  pc3.productname as pname,sum(
			           case when pp.paygubn='ACC' then ifnull(ps.amt,0)+ifnull(ps.vat,0) when pp.paygubn='CAN' then 0-ifnull(ps.amt,0)+ifnull(ps.vat,0) else 0 end
			        ) as pamt
			        from pos_salelist ps
			           inner join pos_company pc 
			              on ps.compcd = pc.compcd
			            inner join pos_compproductgroup pc2 
			               on ps.productcd = pc2.productcd and ps.compcd = pc2.compcd and pc.compcd = pc2.compcd
			            inner join pos_compproduct pc3 
			               on pc.compcd = pc3.compcd and pc2.compcd = pc3.compcd and pc2.productid = pc3.productid 
			            inner join pos_payment pp 
			               on ps.compcd = pp.compcd and ps.paymentcd = pp.paymentcd  and pc.compcd = pp.compcd
			        where  1=1 and pc.compcd=#{compcd}
			             and ps.salesday between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
			             and pc3.productid not in(select productid from pos_comppassproduct where compcd=#{compcd})
			        group by pc3.productid , pc3.productname
			        order by sum(
			           case when pp.paygubn='ACC' then ifnull(ps.amt,0)+ifnull(ps.vat,0) when pp.paygubn='CAN' then 0-ifnull(ps.amt,0)+ifnull(ps.vat,0) else 0 end
			            ) asc
			      ) pp on 1=1
			      ,(select @rownum1:=0) r   
		   ) list2
		   union all
		   select list3.name ,replace(FORMAT(@rownum2 := @rownum2+1,0),',','') as no
		   FROM 
		   (
		   select ww.ti  as name
		   from(
		      SELECT tt.ti,
		            round(ifnull(w1.tot,0)/1000) as tot1,
		            round(ifnull(w1.amt,0)/1000) as amt1
		         from (
		         select '01' as d ,'AM 01:00' as ti
		         union all
		         select '02' as d ,'AM 02:00' as ti
		         union all
		         select '03' as d ,'AM 03:00' as ti
		         union all
		         select '04' as d ,'AM 04:00' as ti
		         union all
		         select '05' as d ,'AM 05:00' as ti
		         union all
		         select '06' as d ,'AM 06:00' as ti
		         union all
		         select '07' as d ,'AM 07:00' as ti
		         union all
		         select '08' as d ,'AM 08:00' as ti
		         union all
		         select '09' as d ,'AM 09:00' as ti
		         union all 
		         select '10' as d ,'AM 10:00' as ti
		         union all 
		         select '11' as d ,'AM 11:00' as ti
		         union all 
		         select '12' as d ,'AM 12:00' as ti
		         union all 
		         select '13' as d ,'PM 01:00' as ti
		         union all 
		         select '14' as d ,'PM 02:00' as ti
		         union all 
		         select '15' as d ,'PM 03:00' as ti
		         union all 
		         select '16' as d ,'PM 04:00' as ti
		         union all 
		         select '17' as d ,'PM 05:00' as ti
		         union all 
		         select '18' as d ,'PM 06:00' as ti
		         union all 
		         select '19' as d ,'PM 07:00' as ti
		         union all 
		         select '20' as d ,'PM 08:00' as ti
		         union all 
		         select '21' as d ,'PM 09:00' as ti
		         union all 
		         select '22' as d ,'PM 10:00' as ti
		         union all 
		         select '23' as d ,'PM 11:00' as ti
		         union all 
		         select '24' as d ,'AM 00:00' as ti
		         ) tt 
		         left outer join
		         (
		         select
		                  ps.auth_ti as d,
		                  sum(case when ps.paygubn='ACC' then total when ps.paygubn='CAN' then 0-total else 0 end) as tot,
		                  sum(case when ps.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) when ps.paygubn='CAN' then 0-ifnull(amt,0)+ifnull(vat,0) else 0 end) as amt
		            from pos_company pc 
		               inner join pos_payment ps on pc.compcd = ps.compcd 
		            where 1=1 and pc.compcd=#{compcd}
		                  and ps.auth_date between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
		            group by ps.auth_ti
		         )w1 on tt.d = w1.d
		         order by tot1 asc 
		      ) ww ,(select @rownum2:=0) r   
		      )list3
		      union all
		      select list4.name,replace(FORMAT(@rownum3 := @rownum3+1,0),',','') as no
		      from(
		         SELECT ifnull(ss.name,'-') as name
					from (select 'name' as gb) a
					left outer join (
					    select 
					       concat(substr(cast( date_format(now(),'%Y') as signed)-cast(ps.birthday as signed),1,1),'0',ps.sex) as name,
					       sum(case when ps.paygubn='ACC' then total when ps.paygubn='CAN' then 0-total else 0 end) as tot
					    from pos_company pc 
					       inner join pos_payment ps on pc.compcd = ps.compcd 
					    where 1=1 and pc.compcd=#{compcd}
					          and ps.auth_date between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(now(),'%Y%m%d')
					          and length(ps.birthday)>=4 and length(ps.sex)>=1
					    group by concat(substr(cast( date_format(now(),'%Y') as signed)-cast(ps.birthday as signed),1,1),'0',ps.sex)
					    order by sum(case when ps.paygubn='ACC' then total when ps.paygubn='CAN' then 0-total else 0 end) asc 
					)ss on 1=1
					,(select @rownum3:=0) r    
		      )list4
		) list
		where no=1
		]]>
	</select>
	
	<!-- 제외상품관리 리스트 조회 -->
	<select id="smain_regiList" parameterType="vo.shopvo.SIncomeDetVO" resultType="vo.shopvo.SIncomeDetVO">
		select
			pc.productcd ,
			pc.productname ,
			ifnull(pc.maker,'') as maker ,
		    ifnull(pc.spec,'') as spec ,
		    ifnull(pc.unit,'') as unit ,
			pc.productid
		from
			pos_compproduct pc
		where compcd = #{compcd}
			<if test="search4 == 'productname'">
				and pc.productname like concat('%',#{searchInput2},'%')
			</if>
			<if test="search4 == 'productid'">
				and pc.productcd like concat('%',#{searchInput2},'%')
			</if>
			<if test="search4 == 'maker'">
				and pc.maker like concat('%',#{searchInput2},'%')
			</if>
			and productid not in(select productid from pos_comppassproduct pc where compcd = #{compcd})
		order by productname asc
	</select>
	
	<!-- 선택한 상품 제외 -->
	<insert id="except_insert" parameterType="vo.shopvo.SIncomeDetVO">
		insert into pos_comppassproduct (
			compcd,
			productid,
			regdt 
		) values(
			#{compcd},
			#{productid},
			now()
		) on duplicate key 
		update 
			upddt = now()
	</insert>
	
	<!-- 제외한 상품 미리보기 -->
	<select id="preview_prod" parameterType="vo.shopvo.SIncomeDetVO" resultType="vo.shopvo.SIncomeDetVO">
		select 
			productcd, 
			productname, 
			maker, 
			spec, 
			unit, 
			productid 
		from pos_compproduct pc 
		where 1=1 
			and compcd = #{compcd}
			and productid in (select productid from pos_comppassproduct pc where compcd = #{compcd})
	</select>
	
	<!-- 제외 취소 상품 삭제하기 -->
	<delete id="except_delete" parameterType="vo.shopvo.SIncomeDetVO">
		delete from pos_comppassproduct 
		where 1=1 
			and compcd = #{compcd}
			and productid = #{productid}
	</delete>
	
	<!-- 가맹점 전체 제외상품 취소 -->
	<delete id="all_remove" parameterType="vo.shopvo.SIncomeDetVO">
		delete from pos_comppassproduct where compcd = #{compcd}
	</delete>
	
</mapper>












