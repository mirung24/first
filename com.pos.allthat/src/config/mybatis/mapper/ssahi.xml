<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ssahi">
	
	<!-- 분기별 요일 통계 -->
	<select id="sdaystat" parameterType="vo.shopvo.SDayStatVO" resultType="vo.shopvo.SDayStatVO">
		select
		   m.we,
		   m.totamt,
		   m.totcnt,
		   m.m,
		   m.f,
		   m.h,
		   m2.best,
		   m3.pname
		from(
		   select
		      DAYOFWEEK(auth_date) as we,
		      sum(case when paygubn='ACC' then ifnull(total,0) when paygubn='CAN' then 0-ifnull(total,0) else 0 end) as totamt,
		      sum(case when paygubn='ACC' then 1 when paygubn='CAN' then -1 else 0 end) as totcnt,
		      sum(case when sex = 'M' then 1 else 0 end) as m,
		      sum(case when sex = 'F' then 1 else 0 end) as f,
		      sum(case when hp is not null or hp != '' then 1 else 0 end) as h
		   from 
		   (
		   select auth_date,paygubn,total,amt,vat,discount,hp,sex
		   from pos_payment_temp
		   where compcd = #{compcd}
		   and auth_date = date_format(now(), '%Y%m%d')
		   union all
		   select auth_date,paygubn,total,amt,vat,discount,hp,sex
		   from pos_payment
		   where compcd = #{compcd}
		   and auth_date between cast(concat(#{y}, #{m1}, '01') as date ) and last_day(concat(#{y}, #{m2}, '01'))
		   ) pp
		   group by DAYOFWEEK(auth_date)
		) m
		left outer join(
		   select
		      auth_date as we,
		      SUBSTRING(group_concat(best order by cnt desc), 1, 3) as best
		   from (
		         select
		           DAYOFWEEK(auth_date) as auth_date,
		           concat(concat(substr(case when date_format(now(), '%Y')-substring(birthday, 1, 4) > 80 then 80
		              else date_format(now(), '%Y')-substring(birthday, 1, 4)
		              end, 1, 1), '0'), sex) as best,count(*) as cnt
		         from 
		         (
		           select auth_date,paygubn,total,amt,vat,discount,hp,sex,birthday
		           from pos_payment_temp 
		            where compcd = #{compcd}
		            and auth_date = date_format(now(), '%Y%m%d')
		            and birthday is not null
		            and birthday != ''
		            and sex is not null
		            and sex != ''
		           union all
		           select auth_date,paygubn,total,amt,vat,discount,hp,sex,birthday
		           from pos_payment
		          where compcd = #{compcd}
		            and auth_date between cast(concat(#{y}, #{m1}, '01') as date ) and last_day(concat(#{y}, #{m2}, '01'))
		            and birthday is not null
		            and birthday != ''
		            and sex is not null
		            and sex != ''
		        ) p
		        group by auth_date,birthday,sex
		      ) pp
		      group by auth_date
		) m2 on m.we = m2.we
		left outer join(
		   SELECT
		      p.we,
		      case when INSTR(GROUP_CONCAT(p2.productname order by p.pcnt desc), ',')>0 then
		            substr(GROUP_CONCAT(p2.productname order by p.pcnt desc), 1, INSTR(GROUP_CONCAT(p2.productname order by p.pcnt desc), ',')-1)
		         else GROUP_CONCAT(p2.productname order by p.pcnt desc)
		         end as pname
		   from (
		      SELECT
		         DAYOFWEEK(salesdate) as we,
		         productcd,
		         count(*) as pcnt
		      from pos_salelist ps
		      where compcd = #{compcd}
		      and paymentcd in(
		         select paymentcd
		         from pos_payment pp
		         where compcd = #{compcd}
		         and auth_date between cast(concat(#{y}, #{m1}, '01') as date ) and last_day(concat(#{y}, #{m2}, '01'))
		          ) group by DAYOFWEEK(salesdate), productcd
		    ) p
		   inner join pos_compproductgroup p2
		      on p.productcd = p2.productcd
		   group by p.we
		) m3 on m.we = m3.we
	</select>
	
	<!-- 분기별 시간대 통계 -->
	<select id="stimestat" parameterType="vo.shopvo.SDayStatVO" resultType="vo.shopvo.SDayStatVO">
		select
		   m.ti,
		   m.totamt,
		   m.totcnt,
		   m.m,
		   m.f,
		   m.h,
		   m2.best,
		   m3.pname
		from (
		   select
		      auth_ti as ti,
		      sum(case when paygubn='ACC' then ifnull(total,0) when paygubn='CAN' then 0-ifnull(total,0) else 0 end ) as totamt,
		      sum(case when paygubn='ACC' then 1 when paygubn='CAN' then -1 else 0 end ) as totcnt,
		      sum(case when sex = 'M' then 1 else 0 end) as m,
		      sum(case when sex = 'F' then 1 else 0 end) as f,
		      sum(case when hp is not null or hp != '' then 1 else 0 end) as h
		   from 
		   (
		      select auth_ti,amt,paygubn,vat,total,discount,sex,hp 
		      from pos_payment_temp 
		      where compcd = #{compcd}
		    and auth_date = date_format(now(),'%Y%m%d')
		    union all
		    select auth_ti,amt,paygubn,vat,total,discount,sex,hp
		      from pos_payment
		    where compcd = #{compcd}
		    and auth_date between cast(concat(#{y},#{m1}, '01') as date ) and last_day(concat(#{y}, #{m2}, '01'))
		   ) pp
		   group by auth_ti
		) m
		left outer join (
		   select
		      ti,
		      SUBSTRING(group_concat(best order by cnt desc), 1, 3) as best
		   from (
		      select
		         auth_ti as ti,
		         concat(concat(substr(case when date_format(now(), '%Y')-substring(birthday, 1, 4) > 80 then 80
		         else date_format(now(), '%Y')-substring(birthday, 1, 4)
		         end, 1, 1), '0'), sex) as best, count(*) as cnt
		      from 
		      (
		       select auth_ti,birthday,sex
		       from pos_payment_temp
		       where compcd = #{compcd}
		       and auth_date = date_format(now(),'%Y%m%d')
		       and birthday is not null
		       and birthday != ''
		       and sex is not null
		       and sex != ''
		       union all
		       select auth_ti,birthday,sex
		       from pos_payment
		       where compcd = #{compcd}
		       and auth_date between cast(concat(#{y},#{m1}, '01') as date ) and last_day(concat(#{y}, #{m2}, '01'))
		       and birthday is not null
		       and birthday != ''
		       and sex is not null
		       and sex != ''
		      ) pp
		      group by
		         auth_ti,
		         concat(concat(substr(case when date_format(now(), '%Y')-substring(birthday, 1, 4) > 80 then 80
		        else date_format(now(), '%Y')-substring(birthday, 1, 4)
		        end, 1, 1), '0'), sex)
		   ) dat
		   group by ti
		) m2 on m.ti = m2.ti
		left outer join(
		   SELECT
		      p.ti,
		      case when INSTR(GROUP_CONCAT(p2.productname order by p.pcnt desc), ',')>0 then
		        substr(GROUP_CONCAT(p2.productname order by p.pcnt desc), 1, INSTR(GROUP_CONCAT(p2.productname order by p.pcnt desc), ',')-1)
		      else GROUP_CONCAT(p2.productname order by p.pcnt desc)
		      end as pname
		   from (
		      SELECT
		         salesti as ti,
		         productcd,
		         count(*) as pcnt
		      from pos_salelist ps
		      where compcd = #{compcd}
		      and paymentcd in(
		         select paymentcd
		         from pos_payment pp
		         where compcd = #{compcd}
		         and auth_date between cast(concat(#{y}, #{m1}, '01') as date ) and last_day(concat(#{y}, #{m2}, '01'))
		      )
		      group by salesti, productcd
		   ) p
		   inner join pos_compproductgroup p2
		    on p.productcd = p2.productcd
		   group by p.ti
		) m3 on m.ti = m3.ti
	</select>
</mapper>












