<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sscreen">
	
	<!-- 등록된 화면 리스트 조회 -->
	<select id="screen_list" parameterType="vo.shopvo.ScreenVO" resultType="vo.shopvo.ScreenVO">
		select dd.*
		from(
			select FLOOR((@rownum + 1 - 1)/ #{pagecnt} + 1) page, replace(FORMAT(@rownum := @rownum + 1, 0),',','') as no, list.*
			from(
					select 
						screencode,
						screenname, 
						startdate, 
						enddate, 
						priority, 
						template,
						regdt
					from pos_custscreen pc 
					where 1=1
					and compcd=#{compcd}
					and screenname like concat('%',#{searchInput},'%')
			)list, (select @rownum := 0) r
			order by regdt asc
		)dd
		where page=#{pageno}
	</select>
	
	<!-- 등록그룹 리스트 건수 -->
	<select id="count" parameterType="vo.shopvo.ScreenVO" resultType="int">
		select count(*)
		from pos_custscreen pc 
		where  compcd=#{compcd}
	</select>
	
	<!-- 스크린 코드 만들기 -->
	<select id="make_scncode" resultType="String">
		select fn_getuuid('SCN') as screencode
	</select>
	
	<!-- 마스터 등록 -->
	<insert id="insert1" parameterType="vo.shopvo.ScreenVO">
		insert into pos_custscreen (
			screencode,
			compcd,
			startdate,
			enddate,
			template,
			priority,
			screenname,
			regdt,
			regcd
		) values (
			#{screencode},
			#{compcd},
			#{startdate},
			#{enddate},
			#{template},
			#{priority},
			#{screenname},
			now(),
			#{regcd}
		)
	</insert>
	
	<!-- 스크린 코드 만들기 -->
	<select id="make_imgcode" resultType="String">
		select fn_getuuid('IMG') as imgcode
	</select>
	
	<!-- 서브 등록(이미지) -->
	<insert id="insert_img" parameterType="vo.shopvo.ScreenVO">
		insert into pos_screenimg (
			imgcode,
			screencode,
			url,
			name,
			displayti,
			volume,
			extension,
			ordernum,
			link
		) values (
			#{imgcode},
			#{screencode},
			#{url},
			#{name},
			#{displayti},
			#{volume},
			#{extension},
			#{ordernum},
			#{link}
		)
	</insert>
	
	<!-- 이미지 삭제 -->
	<delete id="delete_img">
		delete from pos_screenimg where imgcode=#{imgcode}
	</delete>
	
	<!-- 스크린 상세보기(마스터 정보) -->
	<select id="detail" parameterType="String" resultType="vo.shopvo.ScreenVO">
		select screenname, startdate, enddate, priority, template 
		from pos_custscreen pc 
		where screencode = #{screencode}
	</select>
	
	<!-- 스크린 상세보기(서브 이미지) -->
	<select id="detail2" parameterType="String" resultType="vo.shopvo.ScreenVO">
		select imgcode, url, name, displayti, ordernum, link, extension
		from pos_screenimg ps 
		where screencode = #{screencode}
		order by ordernum asc
	</select>
	
	<!-- 스크린 삭제하기(마스터) -->
	<delete id="del_screen" parameterType="String">
		delete from pos_custscreen where screencode = #{screencode}
	</delete>
	
	<!-- 스크린 삭제하기(서브) -->
	<delete id="del_img" parameterType="String">
		delete from pos_screenimg where screencode = #{screencode}
	</delete>
	
	<!-- 마스터 수정 -->
	<update id="modi_mas" parameterType="vo.shopvo.ScreenVO">
		update pos_custscreen set
			startdate=#{startdate},
			enddate=#{enddate},
			template=#{template},
			priority=#{priority},
			screenname=#{screenname},
			regcd=#{regcd},
			upddt=now()
		where screencode=#{screencode}
	</update>
	
	<!-- 기존에 있던 이미지 수정 -->
	<update id="exis_img" parameterType="vo.shopvo.ScreenVO">
		update pos_screenimg set
			displayti=#{detdis},
			ordernum=#{detorn},
			link=#{detlink}
		where imgcode=#{detimcd}
	</update>
	
	<!-- 삭제한 이미지 db에서 삭제하기 -->
	<delete id="detimg_del" parameterType="String">
		delete from pos_screenimg 
		where imgcode = #{imgcode}
	</delete>
</mapper>












