<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sstat">
<!-- 그래프 조회(월간 전체/otc) -->
   <select id="sstat_mgrp" parameterType="String" resultType="vo.shopvo.SStatGraphVO">
		select 
		      substr(ps.auth_date,7,8) as mday,
		      sum(case when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='ACC' then ifnull(total,0) 
		               when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='CAN' then 0-ifnull(total,0)
		          else 0 end) as mtot,
		      sum(case when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		               when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		          else 0 end) as mamt,
		      sum(case when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now() - interval 1 month,'%Y%m'),'01') and date_format(last_day(now() - interval 1 month),'%Y%m%d') and paygubn='ACC' then ifnull(total,0) 
		               when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now() - interval 1 month,'%Y%m'),'01') and date_format(last_day(now() - interval 1 month),'%Y%m%d') and paygubn='CAN' then 0-ifnull(total,0)
		          else 0 end) as mtot1,
		      sum(case when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now() - interval 1 month,'%Y%m'),'01') and date_format(last_day(now() - interval 1 month),'%Y%m%d') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) 
		               when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now() - interval 1 month,'%Y%m'),'01') and date_format(last_day(now() - interval 1 month),'%Y%m%d') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		          else 0 end) as mamt1,
		      sum(amt)/count(distinct(ps.compcd)) as mcustavg1,
		      sum(total)/count(distinct(ps.compcd)) as mcustavg2
		  from pos_payment ps
		  where ps.auth_date between concat(date_format(now() - interval 1 month,'%Y%m'),'01') 
		     and date_format(last_day(now()),'%Y%m%d') 
		     and ps.compcd in (select compcd from pos_chaincompany where chaincode = (select chaincode from pos_chaincompany where compcd=#{compcd}))
		  group by mday
   </select>
   
   <!-- 그래프 조회(주간 전체/otc) -->
   <select id="sstat_wgrp" parameterType="String" resultType="vo.shopvo.SStatGraphVO">
		SELECT wda.wday,
		     round(ifnull(w1.tot,0)) as wtot1,
		     round(ifnull(w2.tot,0)) as wtot2,
		     round(ifnull(w1.amt,0)) as wamt1,
		     round(ifnull(w2.amt,0)) as wamt2,
		     ifnull(w1.custavg,0) as wcustavg1,
		     ifnull(w1.custavg2,0) as wocustavg1,
		     ifnull(w2.custavg,0) as wcustavg2,
		     ifnull(w2.custavg2,0) as wocustavg2
		  from (
		  select 1 as d ,'일' as wday
		  union all
		  select 2 as d ,'월' as wday
		  union all 
		  select 3 as d ,'화' as wday
		  union all 
		  select 4 as d ,'수' as wday
		  union all 
		  select 5 as d ,'목' as wday
		  union all 
		  select 6 as d ,'금' as wday
		  union all 
		  select 7 as d ,'토' as wday
		  ) wda 
		  left outer join
		  (
		     select
		           DAYOFWEEK(date_format(pp.auth_date,'%Y%m%d')) as d,
		           sum(case when pc.compcd=#{compcd} and pp.paygubn='ACC' then total when pc.compcd=#{compcd} and pp.paygubn='CAN' then 0-ifnull(total,0)  else 0 end) as tot,
		           sum(case when pc.compcd=#{compcd} and pp.paygubn='ACC' then amt+vat when pc.compcd=#{compcd} and pp.paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0)) else 0 end) as amt,
		           sum(case when pp.paygubn='ACC' then total when pp.paygubn='CAN' then 0-ifnull(total,0)  else 0 end)/count(distinct(pc.compcd)) as custavg,
		           sum(case when pp.paygubn='ACC' then amt+vat when pp.paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0)) else 0 end)/count(distinct(pc.compcd)) as custavg2
		     from pos_company pc 
		        inner join (
		           select compcd,auth_date,paygubn,total,amt,vat,discount
		           from pos_payment_temp
		           where  1=1 
		            and compcd in (
		              select compcd from pos_chaincompany where chaincode = (select chaincode from pos_chaincompany where compcd=#{compcd})
		            )
		            and auth_date = date_format(now(),'%Y%m%d')
		           union all 
		           select compcd,auth_date,paygubn,total,amt,vat,discount
		            from pos_payment
		            where  1=1 
		            and compcd in (
		              select compcd from pos_chaincompany where chaincode = (select chaincode from pos_chaincompany where compcd=#{compcd})
		            )
		            and auth_date between date_format(ADDDATE(now(),1-(DAYOFWEEK(now()))),'%Y%m%d') and date_format(now(),'%Y%m%d')
		     ) pp on pc.compcd = pp.compcd 
		     group by pp.auth_date    
		  )w1 on wda.d = w1.d
		  left outer join
		  (
		     select
		           DAYOFWEEK(date_format(pp.auth_date,'%Y%m%d')) as d,
		           sum(case when pc.compcd=#{compcd} and pp.paygubn='ACC' then total when pc.compcd=#{compcd} and pp.paygubn='CAN' then 0-total  else 0 end) as tot,
		           sum(case when pc.compcd=#{compcd} and pp.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) when pc.compcd=#{compcd} and pp.paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0)) else 0 end) as amt,
		           sum(case when pp.paygubn='ACC' then ifnull(total,0) when pp.paygubn='CAN' then 0-ifnull(total,0) else 0 end)/count(distinct(pc.compcd)) as custavg,
		           sum(case when pp.paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0) when pp.paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0)) else 0 end)/count(distinct(pc.compcd)) as custavg2
		     from pos_company pc 
		        inner join 
		        (
		        select compcd,auth_date,paygubn,total,amt,vat,discount
		           from pos_payment_temp
		           where  1=1 
		            and compcd in (
		              select compcd from pos_chaincompany where chaincode = (select chaincode from pos_chaincompany where compcd=#{compcd})
		            )
		            and auth_date = date_format(now(),'%Y%m%d')
		           union all 
		           select compcd,auth_date,paygubn,total,amt,vat,discount
		            from pos_payment
		            where  1=1 
		            and compcd in (
		              select compcd from pos_chaincompany where chaincode = (select chaincode from pos_chaincompany where compcd=#{compcd})
		            )
		            and auth_date between date_format(ADDDATE(now(),interval - 6 day),'%Y%m%d') and date_format(ADDDATE(now(),0-(DAYOFWEEK(now()))),'%Y%m%d')
		        ) pp on pc.compcd = pp.compcd 
		     group by pp.auth_date    
		  ) w2 on wda.d = w2.d
		  order by wda.d
   </select>
   
   <!-- 그래프 조회(시간 전체/otc) -->
   <select id="sstat_tgrp" parameterType="String" resultType="vo.shopvo.SStatGraphVO">
		SELECT 
		     tt.ti,
		     ifnull(dat.ttot, 0) as ttot,
		     ifnull(dat.tamt, 0) as tamt,
		     ifnull(dat.ttot1, 0) as ttot1,
		     ifnull(dat.tamt1, 0) as tamt1,
		     ifnull(dat.tcustavg1, 0) as tcustavg1,
		     ifnull(dat.tcustavg2, 0) as tcustavg2
		  from (
		     select '00' as ti union all select '01' as ti union all select '02' as ti union all select '03' as ti union all select '04' as ti union all select '05' as ti
		        union all select '06' as ti union all select '07' as ti union all select '08' as ti union all select '09' as ti union all select '10' as ti
		        union all select '11' as ti union all select '12' as ti union all select '13' as ti union all select '14' as ti union all select '15' as ti
		        union all select '16' as ti union all select '17' as ti union all select '18' as ti union all select '19' as ti union all select '20' as ti
		        union all select '21' as ti union all select '22' as ti union all select '23' as ti 
		  ) tt 
		  left outer join(
		     select
		        ps.auth_ti as ti,
		        sum(
		           case when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='ACC' then ifnull(total,0)
		                when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='CAN' then 0-ifnull(total,0)
		           else 0 end
		        ) as ttot,
		        sum(
		           case when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		                when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		           else 0 end
		        ) as tamt,
		        sum(
		           case when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now() - interval 1 month,'%Y%m'),'01') and date_format(last_day(now() - interval 1 month),'%Y%m%d') and paygubn='ACC' then ifnull(total,0) 
		                when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now() - interval 1 month,'%Y%m'),'01') and date_format(last_day(now() - interval 1 month),'%Y%m%d') and paygubn='CAN' then ifnull(total,0)
		           else 0 end
		        ) as ttot1,
		        sum(
		           case when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now() - interval 1 month,'%Y%m'),'01') and date_format(last_day(now() - interval 1 month),'%Y%m%d') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		                when ps.compcd=#{compcd} and ps.auth_date between concat(date_format(now() - interval 1 month,'%Y%m'),'01') and date_format(last_day(now() - interval 1 month),'%Y%m%d') and paygubn='ACC' then 0-(ifnull(amt,0)+ifnull(vat,0))
		           else 0 end
		        ) as tamt1,
		        sum(
		        case when ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='ACC' then ifnull(amt,0)+ifnull(vat,0)
		                when ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='CAN' then 0-(ifnull(amt,0)+ifnull(vat,0))
		           else 0 end
		        )/count(distinct(ps.compcd)) as tcustavg1,
		         sum(
		         case when ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='ACC' then ifnull(total,0)
		                when ps.auth_date between concat(date_format(now(),'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d') and paygubn='CAN' then 0-ifnull(total,0)
		           else 0 end
		         )/count(distinct(ps.compcd)) as tcustavg2
		      from pos_payment ps 
		         inner join pos_company pc on ps.compcd = pc.compcd
		         where 1=1 
		    and ps.compcd in (
		        select compcd from pos_chaincompany where chaincode = (select chaincode from pos_chaincompany where compcd=#{compcd})
		      )
		         and ps.auth_date between concat(date_format(now() - interval 1 month,'%Y%m'),'01') and date_format(last_day(now()),'%Y%m%d')
		           group by ti
		  )dat on tt.ti = dat.ti
   </select>
</mapper>












